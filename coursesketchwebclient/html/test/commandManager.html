<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<base href="../../">
    <title>Drawing!</title>
  	<link rel="stylesheet" href="css/utility/columns.css">
	<link rel="stylesheet" href="css/SRL/SRL_SketchViewer.css">

	<script type="text/javascript" src="js/connection/libraries/Long.min.js"></script>
	<script type="text/javascript" src="js/connection/libraries/ByteBuffer.min.js"></script>
	<script type="text/javascript" src="js/connection/libraries/Protobuf.min.js"></script>

    <script type="text/javascript" src="js/utils/loadingManager.js"></script>
    <script type="text/javascript" src="js/utils/utilityFunctions.js"></script>

	<script type="text/javascript" src="js/input/sketching.js"></script>
	<script type="text/javascript" src="js/SRL/SRL_Library.js"></script>
	<script type="text/javascript" src="js/input/touch_event.js"></script>
	<script type="text/javascript" src="js/SRL/SRL_Graphics.js"></script>
	<script type="text/javascript" src="js/test/SRL_SketchViewer.js"></script>

	<script type="text/javascript" src="js/connection/connection_library.js"></script>
	<script type="text/javascript" src="js/connection/drawing_communication.js"></script>
	<script type="text/javascript" src="js/connection/update_manager.js"></script>
	<script type="text/javascript" src="js/test/Command_Viewer.js"></script>
    <link rel="icon" type="image/ico" href="images/CSpencil.ico">
    <script type="text/javascript">
		var drawingCreator = false;
		var sketch = false;
		var canvasContext = false;
		var commandManager = false;
		var serverConnection = false;
		var clearCanvas = false;
		var createBaseCommand = false;

		var sketchOutput = 'sketch_output';
		var updateOutput = 'update_output';
	    addLoadEvent(function () {
			var input = new inputListener();
			input.initializeCanvas("drawingCanvas");
			clearCanvas = input.clearCanvas;
			canvasContext = input.canvasContext;
			sketch = new SRL_Sketch();
			sketch.canvasContext = canvasContext;
			sketch.clearCanvas = clearCanvas;
			drawingCreator = new drawingInputCreator(input, sketch, callback, canvasContext);
			createStuff();
			initializeServer();
		});

	    function callback(stroke) {
	    	stroke.setColorHex(convertRGBtoHex(0,255,0,255));

			sketch.drawEntireSketch();

			addUpdateFromStroke(stroke);

			// debugging!
			createViewer();
		}

	    function initializeServer() {
	    	var wsUri = "goldberglinux02.tamu.edu:8888"; // our serve
	    	serverConnection = new Connection(wsUri,false);
	    	serverConnection.setOnCloseListener(function(evt) {
				var reconnect = false;
				if (evt.code == CONNECTION_LOST) {
					alert('can not connect to the server');
					reconnect = true;
				} else if(evt.code == SERVER_FULL) {
					alert(evt.reason); // Here we can try to connect to other servers.
				} else {
					alert("SERVER CLOSED CONNECTION");
					reconnect = true;
				}
				if (reconnect) {
					console.log("attempting to reconnet");
					intervalVariable = setInterval(function() {console.log("RECONNECTING!");createWebSocket();}, 3000); 
				}
			});

	    	serverConnection.setOnOpenListener(function(evt) {
			});
			commandManager = new UpdateManager(sketch, serverConnection, ProtoSrlUpdate,
					ProtoSrlCommand, ProtoSrlCommandType, ProtoUpdateCommand);
			serverConnection.setRecognitionListener(function(evt, message) {
				if (message.requestType == parent.Request.MessageType.RECOGNITION) {
					var data = message.otherData;
					var update = parent.ProtoSrlUpdate.decode(data);
					commandManager.addUpdate(update, true);
					setTimeout(function() {createViewer();},50);
				}
			});
			createBaseCommand = serverConnection.createBaseCommand;
	    }

	    function addUpdateFromStroke(stroke) {
	    	var command = createBaseCommand(ProtoSrlCommandType.ADD_STROKE, true);
			// then finish him!
			command.commandData = stroke.sendToProtobuf(this).toArrayBuffer();
			command.decodedData = stroke;
			var array = new Array();
			array.push(command);
			var update = serverConnection.createUpdateFromCommands(array);
			commandManager.addUpdate(update, false);
	    }

	    function createStuff() {
	    	//goes 5 times
	    	for(var i = 1; i <= 2; i++) {
	    		sketch.addObject(getShape(i));
	    	}
	    	console.log(sketch.getList());
	    	var list = sketch.getList();
	    	createViewer();
	    }

	    function getShape(i) {
	    	this.shape = new SRL_Shape();
    		// goes 1 to 5 times
    		for(var j = 0; j < i; j++) {
    			console.log('j: '+ j);
    			var stroke = new SRL_Stroke();
    			this.shape.addSubObject(stroke);
    		}
    		return shape;
	    }

	    function packageShapes() {
	    	var shape = new SRL_Shape();
	    	var firstCommand = createBaseCommand(ProtoSrlCommandType.ADD_SHAPE, false);
	    	firstCommand.commandData = shape.sendToProtobuf(this).toArrayBuffer();
	    	firstCommand.decodedData = shape;
	    	var secondCommand = createBaseCommand(ProtoSrlCommandType.PACKAGE_SHAPE, false);
	    	var packageShape = new ProtoUpdateCommand.PackageShape();
	    	var list = sketch.getList();
	    	var idList = [];
	    	for (var i = 0; i < list.length; i ++) {
	    		idList.push(sketch.getSubObjectAtIndex(i).getId());
	    	}
	    	packageShape.setShapesToBeContained(idList);
	    	var chain = new IdChain();
	    	var chChain = new Array();
	    	chChain.push(shape.getId());
	    	chain.setIdChain(chChain);
	    	packageShape.setNewContainerId(chain);
	    	secondCommand.commandData = packageShape.toArrayBuffer();
	    	secondCommand.decodedData = packageShape;
	    	var array = new Array();
			array.push(firstCommand);
			array.push(secondCommand);
			var update = serverConnection.createUpdateFromCommands(array);
			commandManager.addUpdate(update, false, true);
			setTimeout(function() {createViewer();},50);
	    }

	    function removeFirst() {
	    	var shape = sketch.getSubObjectAtIndex(0);

	    	var chain = new IdChain();
	    	var chChain = new Array();
	    	chChain.push(shape.getId());
	    	chain.setIdChain(chChain);

	    	var command = createBaseCommand(ProtoSrlCommandType.REMOVE_OBJECT, true);
	    	command.commandData = chain.toArrayBuffer();
	    	command.decodedData = chain;
	    	var array = new Array();
			array.push(command);

			var update = serverConnection.createUpdateFromCommands(array);
			commandManager.addUpdate(update, false, true);
			setTimeout(function() {createViewer();},50);
	    }
	    
	    function createViewer() {
	    	createSketchViewer(sketch.getList(), sketchOutput);
	    	if (commandManager) {
		    	createCommandViewer(commandManager.getUpdates(), updateOutput);
	    	}
	    }
	</script>
</head>
<body>
	version 5
    <!-- Center Section -->
	<button onclick = "createStuff();">addShape</button>
	<button onclick = "packageShapes();">packageSketch</button>
	<button onclick = "removeFirst();">removeFirst</button>
	<div id = "sketch_output" style = "height:400px;position:relative; overflow:scroll;border:1px;border-style:solid;"></div>
	<canvas id="drawingCanvas" width="300" height="300" style="top:0px; left:0px; width: 300; height: 300; background:#FFFFFF;float:left;"></canvas>
	<div id = "update_output" style = "width:600px; height:600px;position:relative; overflow:scroll;border:1px;border-style:solid;"></div>
</body>