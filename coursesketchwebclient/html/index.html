<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<base href="../">
	<title>Welcome!</title>
	<script type="text/javascript" src="js/connection/libraries/Long.min.js"></script>
	<script type="text/javascript" src="js/connection/libraries/ByteBuffer.min.js"></script>
	<script type="text/javascript" src="js/connection/libraries/Protobuf.min.js"></script>
   	<script type="text/javascript" src="js/utils/loadingManager.js"></script>
   	<script type="text/javascript" src="js/utils/utilityFunctions.js"></script>

   	<script type="text/javascript" src="js/connection/connection_library.js"></script>
    <link rel="icon" type="image/ico" href="images/CSpencil.ico">
	<style>
	html, body {
	    margin: 0px;
	    padding: 0px;
	    border: 0px;
	    width: 100%;
	    height: 100%;
	}
	body {
		background: #DCDDDF;
	}
	</style>
	<script>
	var connection = false;
	var connected = false;
	var intervalVariable = false;
	function createWebSocket() {
		console.log("connecting");
		//	var wsUri = "echo.websocket.org/"; // echo server
		var wsUri = "goldberglinux.tamu.edu:8887"; // our server
		//var wsUri = "localhost:8887"; // local server
		connection = new Connection(wsUri,false);

		connection.setOnCloseListener(function(evt) {
			var reconnect = false;
			if (evt.code == CONNECTION_LOST) {
				alert('can not connect to the server');
				reconnect = true;
			} else if(evt.code == SERVER_FULL) {
				alert(evt.reason); // Here we can try to connect to other servers.
			} else {
				alert("SERVER CLOSED CONNECTION");
				reconnect = true;
			}
			if (reconnect) {
				console.log("attempting to reconnet");
				intervalVariable = setInterval(function() {console.log("RECONNECTING!");createWebSocket();}, 3000); 
			}
		});
		connection.setOnOpenListener(function(evt) {
			// do something on opening?
			alert("You are now able to log in");
			connected = true;
			if (intervalVariable) {
				clearInterval(intervalVariable);
			}
		});
	}
	function Redirector(scope) {
		var scope = scope;
		var activeState = false;
		/**
		Sets the hash url to the file location.
		
		This allows us to find the url if something were to happen.
		*/
		this.setRedirect = function setRedirect(url) {
			var shortUrl = replaceAll('html','',url); // Remove html from file ending
			var hashUrl = replaceAll('/','.',shortUrl);
			var trimmedHash = hashUrl.substring(1,hashUrl.length-1); // Trim ending
			var replacedHash = ('' + window.location).split('#')[0] + '#' + trimmedHash;
			scope.location.replace(replacedHash);
		}

		function replaceAll(find, replace, str) {
			  return str.replace(new RegExp(find, 'g'), replace);
		}

		this.getRedirect = function getRedirect() {
			var starting = scope.location.hash.substring(1);
			var addedSlashes = 'html/' + replaceAll('\\.','/',starting) + '.html';
			return addedSlashes;
		}

		/*
		// TODO: add this functionality for hash changes!
		this.addState = function appendState(string state) {
			if (!activeState) {
				activeState = true;
				
				return;
			}
			
			window.location.hash
		}
		
		this.getState = function() {
			
		}
		
		this.removeState = function addState() {
			
		}

		this.replaceState = function addState() {
			
		}
		*/
		this.moveWindow = function(url) {
			document.getElementById('iframeContent').src = url;
		}
	}
	createWebSocket();
	var redirector = new Redirector(window);
	window.onload = function() {
		//redirector.setRedirect('html/login/login.html');
	}
	</script>
</head>
<body>
<iframe id="iframeContent" width = "100%" height = "100%" frameborder="0" src = "html/login/login.html" style="display:block"></iframe>
</body>
</html>