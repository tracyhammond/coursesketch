<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <base href="../../">
        <title>Course Sketch</title>
        <script type="text/javascript" src="js/connection/libraries/Long.min.js"></script>
		<script type="text/javascript" src="js/connection/libraries/ByteBuffer.min.js"></script>
		<script type="text/javascript" src="js/connection/libraries/Protobuf.min.js"></script>
        <script type="text/javascript" src="js/connection/connection_library.js"></script>
    	<script type="text/javascript" src="js/utils/loadingManager.js"></script>
    	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/sha3.js"></script>
    	<link rel="stylesheet" href="css/utility/toggleswitch.css">
    	<link rel="stylesheet" href="css/inputStyles/style1.css">
        <link rel="stylesheet" type="text/css" href="css/login/introForms.css" />
       <link rel="icon" 
            type="image/ico" 
            href="/images/CSpencil.ico" />   
		<script type='text/javascript'>
			//called when login button is pressed
			parent.copyParentUtilityFunctions(this);
            function formSubmit() {
				function sendLogin(arg1, arg2) {
					if (!parent.connected) {
						alert("The server has not yet opened a connection, please be patient");
						return;
					}
	  				var request = new Request(parent.Request.MessageType.LOGIN);
	  				var loginInfo = new LoginInformation(arg1, CryptoJS.SHA3(arg2), false, false, "");
	  				request.login = loginInfo;
	  				connection.sendRequest(request);
	  				console.log("Sending login information");
	  			}
				sendLogin(document.getElementById("username").value, document.getElementById("password").value);
            }

            function setup() {
            	connection = parent.connection;
            	parent.copyParentProtos(this);
	  			function onOpen(evt) {
	  				console.log("Opened here which means something bad happened");
	  				parent.connected = true;
	  			}

	  			function onClose(evt, attemptingToReconnect) {
	  				// logout.
	  				if (evt.code == CONNECTION_LOST) {
	  					if (!attemptingToReconnect) {
	  						alert('can not connect to the server');
	  					}
	  				} else if (evt.code == SERVER_FULL) {
	  					if (!attemptingToReconnect) {
	  						alert(evt.reason);
	  					}
	  				} else if (evt.code == INCORRECT_LOGIN) {
	  					alert(evt.reason);
	  					return false;
	  				}
	  				if (!attemptingToReconnect) {
	  					alert("Closing");
	  				}
	  			}

	  			function onLogin(evt, message) {
	  				if (message.login && message.login.isLoggedIn) {
	  					// successful login here
	  					connection.isInstructor = message.login.isInstructor;
	  					connection.userId = message.login.userId;
	  					parent.redirector.moveWindow("html/main.html");
	  					console.log("Redirecting to the other window");
	  				} else {
	  					alert("not able to login: " + message.responseText);
	  				}
	  			}

	  			function onError(evt, error) {
	  				// through an uhoh oreo.
	  				//alert('OMG AN ERROR ' + error);
	  			}
	  			connection.setListeners(onOpen, onClose, false, onError);
	  			connection.setLoginListener(onLogin);
	  		}
	  		var connection = false;
        </script>
    </head>
    <body onload="setup();">
        <div class="container">
          <section id="content">
            <!-- Login Form: Username and Password field. Checks with Middle for confirmation -->
            <div id="form" stlye = "position:relative;">
                <form action="Javascript:formSubmit()">
                    <h1>CourseSketch</h1>
                    <div id="user">
                        <input type="text" name="username" placeholder="Username" required="" id="username" autofocus/>
                    </div>
                    <div id="user">
                        <input type="password" name="password" placeholder="Password" required="" id="password" />
                    </div>
                    <div>
    					<input type="submit" value="Login">
    					<a href="recovery.php">Lost your password?</a>
                    </div>
                </form>
            </div>
            <div class="button" onclick="window.location='html/login/register.html'">
            	<a href="html/login/register.html">Register</a>
            </div>
          </section>
        </div>
    </body>
</html>
