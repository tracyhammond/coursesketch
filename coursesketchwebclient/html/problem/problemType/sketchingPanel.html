<!DOCTYPE html>
<html>
<base href="../../../">
  	<link rel="stylesheet" href="css/utility/columns.css">
  	<script type="text/javascript" src="js/utils/utilityFunctions.js"></script>
 
	<script type="text/javascript" src="js/input/touch_event.js"></script>

	<script type="text/javascript" src="js/SRL/SRL_Library.js"></script>
	<script type="text/javascript" src="js/SRL/SRL_Graphics.js"></script>
	<script type="text/javascript" src="js/input/sketching.js"></script>

	<script type="text/javascript" src="js/connection/sketch_communication.js"></script>
	<script type="text/javascript" src="js/connection/update_manager.js"></script>
	<script type="text/javascript" src="js/connection/submission.js"></script>
	<script type="text/javascript" src="js/input/highlighter.js"></script>
    <link rel="icon" type="image/ico" href="images/CSpencil.ico">
    <script type="text/javascript">
    	parent.copyParentUtilityFunctions(this);
    	parent.copyParentProtos(this);

		var serverConnection = parent.connection;
		var drawingCreator = false;
		var sketch = false;
		var canvasContext = false;
		var Long = false;
		var commandManager = false;
		var highlighter = false;

	    function initializeInput() {
	    	var ProtoSubmissionBuilder = parent.ProtoSubmissionBuilder;
			var input = new inputListener();
			input.initializeCanvas("drawingCanvas");
			canvasContext = input.canvasContext;

			sketch = new SRL_Sketch();
			sketch.canvasContext = canvasContext;
			drawingCreator = new drawingInputCreator(input, sketch, callback, canvasContext);
			highlighter = new Highlighter(input, sketch, callback, canvasContext);

			commandManager = new UpdateManager(sketch, serverConnection, parent.ProtoSrlUpdate,
					parent.ProtoSrlCommand, parent.ProtoSrlCommandType, parent.ProtoUpdateCommand);
			serverConnection.setRecognitionListener(function(evt, message) {
				if (message.requestType == parent.Request.MessageType.RECOGNITION) {
					var data = message.otherData;
					var update = parent.ProtoSrlUpdate.decode(data);
					commandManager.addUpdate(update, true);
				}
			});

			var submitFunction = function() {
				var experiment = new ProtoSubmissionBuilder.SrlExperiment();
				experiment.submission = new ProtoSubmissionBuilder.SrlSubmission();
				parent.problemNavigator.setSubmissionInformation(experiment, true);

				submitUpdateList(serverConnection, commandManager.getUpdates(), [ProtoUpdateCommand, ProtoSubmissionBuilder], experiment,
						Request.MessageType.SUBMISSION, displayBar, updateBar, finishBar);
			};
			parent.problemNavigator.addEventMapping("submit", submitFunction);

			var feedbackFunction = function(args) {
				console.log(args);
				event = args[0];
				msg = args[1];
				if (msg.responseText) {
					alert(msg.responseText);
				} else {
					alert("GETTING FEEDBACK!");
				}
			};
			parent.problemNavigator.addEventMapping("feedback", feedbackFunction);

			window.addEventListener("beforeunload", function( e ) {
				parent.problemNavigator.removeEventMapping("submit", submitFunction);
				parent.problemNavigator.removeEventMapping("feedback", feedbackFunction); 
			});
		}

	    function callback(stroke) {
			stroke.draw(canvasContext);
			addUpdateFromStroke(stroke);
		}

	    /**
	    Creates an update that is added to the update manager, given a stroke.
	    */
	    function addUpdateFromStroke(stroke) {
	    	var command = serverConnection.createBaseCommand(ProtoSrlCommandType.ADD_STROKE, true);
			// then finish him!
			command.commandData = stroke.sendToProtobuf(parent).toArrayBuffer();
			command.decodedData = stroke;
			var array = new Array();
			array.push(command);
			var update = serverConnection.createUpdateFromCommands(array);
			commandManager.addUpdate(update, false);
	    }

	    function displayBar() {
	    	document.getElementById("PercentBar").style = "display:block;position:absolute;left:20px;top:20px;"
	    }
	    function updateBar(index, total) {
	    	document.getElementById("PercentBar").innerHTML = "" + (index/total) * 100 + "% total: "+total;
 	    }
	    function finishBar() {
	    	alert("done submitting");
	    }
	</script>
	<script type="text/javascript">
		(function(scope){
			addScopedLoadEvent(scope.window, function() {
				initializeInput();
				fillScreen(scope, 'drawingCanvas');
				sketch.drawEntireSketch();
	  		});

			scope.window.onresize = function() {
				scope.fillScreen(scope, 'drawingCanvas');
				sketch.drawEntireSketch();
			}
		})(this);
	</script>
	<style>
	html, body {
	    margin: 0px;
	    padding: 0px;
	    border: 0px;
	}
	</style>
</head>
<body>
	<div id = "PercentBar">0%</div>
	<canvas id="drawingCanvas" width="800" height="600" style="top:0px; left:0px; width: 800; height: 100%; background:#FFFFFF;"></canvas>
</body>