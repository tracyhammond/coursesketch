<!DOCTYPE html>
<html>
<base href="../../">
  	<link rel="stylesheet" href="css/utility/columns.css">
	<script type="text/javascript" src="js/input/drawing.js"></script>
	<script type="text/javascript" src="js/SRL/SRL_Library.js"></script>
	<script type="text/javascript" src="js/input/touch_event.js"></script>
	<script type="text/javascript" src="js/SRL/SRL_Graphics.js"></script>
	<script type="text/javascript" src="js/connection/drawing_communication.js"></script>
    <link rel="icon" type="image/ico" href="images/CSpencil.ico">
    <script type="text/javascript">
		var serverConnection = parent.connection;
		var drawingCreator = false;
		var sketch = false;
		var canvasContext = false;
		var Long = false;
		
    	function init() {
    		parent.redirector.setRedirect('html/drawing/drawing.html');
    		initializeProtos();
    		initializeInput();
    		matchParent('drawingCanvas');
    	}
    	/**
    		Creates the proto files required for drawing if they do not exist.
    	*/
    	function initializeProtos() {
    		Long = parent.Long;
   			// blah
   			//testProtobuf(parent);
    	}

	    function initializeInput() {
			var input = new inputListener();
			input.initializeCanvas("drawingCanvas");
			canvasContext = input.canvasContext;
			sketch = new sketchContainer();
			sketch.canvasContext = canvasContext;
			drawingCreator = new drawingInputCreator(input, sketch, callback, canvasContext);
			serverConnection.setOnMessageListener(function(evt, message) {
				//alert('I AM GETTING A MESSAGE');
				if (message.requestType == parent.Request.MessageType.RECOGNITION) {
					//alert("Recieving recognition");
					var data = message.otherData;
					var update = parent.ProtoSrlUpdate.decode(data);
					var commandList = update.getCommands();
					//if(commandList ) // if it is not an array...
					//alert("CommandList " + commandList);
					for (var i = 0; i <commandList.length; i++) {
						var command = commandList[i];
						if (command.commandType == parent.ProtoSrlCommandType.ADD_STROKE) {
							var newStroke = SRL_Stroke.createFromProtobuf(command.commandData);
							sketch.addObject(newStroke);
							sketch.drawEntireSketch();
						} else if(command.commandType == parent.ProtoSrlCommandType.ADD_SHAPE) {
							var newShape = SRL_Shape.createFromProtobuf(command.commandData);
							sketch.addObject(newShape);
							sketch.drawEntireSketch();
						}
					}
				}
			});
		}

	    function callback(stroke) {
			stroke.draw(canvasContext);
			var command = new parent.ProtoSrlCommand();
			command.time = stroke.time;
			command.commandType = parent.ProtoSrlCommandType.ADD_STROKE;
			command.isUserCreated = true;
			command.commandId = generateUUID(); // unique ID
			// then finish him!
			command.commandData = stroke.sendToProtobuf(parent).toArrayBuffer();
			var request = serverConnection.createRequestFromCommand(command, parent.Request.MessageType.RECOGNITION);
			serverConnection.sendRequest(request);
		}
	</script>
	<script type="text/javascript">
			parent.addScopedLoadEvent(window, function() {
	  				matchParent('drawingCanvas');
	  		});

			window.onresize = function() {
					matchParent('drawingCanvas');
			}

	  		function matchParent(id) {
	  			var body = document.body,
			    html = document.documentElement;
				var height = window.innerHeight - 4;
				var width = window.innerWidth - 4;
				var element = document.getElementById('drawingCanvas');
				element.height = height - element.offsetTop;
				element.width = width  - element.offsetLeft;
				element.style.width = element.width;
				element.style.height = element.height;
				drawEntireSketch();
	  		}

	</script>
	<style>
	html, body {
	    margin: 0px;
	    padding: 0px;
	    border: 0px;
	}
	</style>
</head>
<body onload="init()">
<div>Problem statement!</div>
		<canvas id="drawingCanvas" width="800" height="600" style="top:0px; left:0px; width: 800; height: 100%; background:#FFFFFF;"></canvas>
</body>