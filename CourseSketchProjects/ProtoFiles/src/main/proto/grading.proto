import "util.proto";

package protobuf.srl.grading;

message ProtoGradingPolicy {
    required string courseId = 1;
    optional PolicyType policyType = 2 [default = PERCENT];
    repeated PolicyCategory gradeCategories = 3;
    repeated DroppedProblems droppedProblems = 4;
    repeated DroppedAssignment droppedAssignments = 5;

    enum PolicyType {
        PERCENT = 1; // Percent based grading policy
        POINT = 2;   // Point based grading policy
    }
}

message DroppedAssignment {
    required string assignmentId = 1;
    optional DropType dropType = 2 [default = NO_COUNT];
}

message DroppedProblems {
    required string assignmentId = 1;
    repeated SingleProblem problems = 2;

    message SingleProblem {
        required string problemId = 1;
        optional DropType dropType = 2 [default = NO_COUNT];
    }
}

enum DropType {
    CORRECT = 1;    // Counts as full credit
    NO_COUNT = 2;   // Worth 0 points or 0 weight
}

message PolicyCategory {
    required string name = 1;
    optional float weight = 2;
    optional LatePolicy latePolicy = 3; // This serves as a default late policy for all assignments in a category
}

message LatePolicy {
    required FunctionType functionType = 1 [default = STEPPING_FUNCTION];
    optional TimeFrame timeFrameType = 2 [default = DAY]; // because this is what people are used to.
    optional float rate = 3;
    optional SubtractionType subtractionType = 4 [default = CAP];// how we are subtracting the grade
    optional bool applyOnlyToLateProblems = 5;

    enum FunctionType {
        STEPPING_FUNCTION = 0;
        LINE = 1;
        EXPONENTIAL = 2;
    }

    /**
     * The numbers are reversed because of how the client loads and saves data for options.
     *
     * Specifically this is used in the advance edit panel.
     */
    enum TimeFrame {
        DAY = 3;
        HOUR = 2;
        MINUTE = 1;
        CONSTANT = 0;
    }

    enum SubtractionType {
        CAP = 0;
        PERCENT = 1;
    }
}

message ProtoGrade {
    required string courseId = 1;
    required string userId = 2;         // Id of the user the grade belongs to.
    optional string assignmentId = 3;
    optional string problemId = 4;
    optional float currentGrade = 5;
    repeated GradeHistory gradeHistory = 6;
    optional bool externalGrade = 7;
}

message GradeHistory {
    optional float gradeValue = 1;
    optional string comment = 2;
    optional protobuf.srl.utils.DateTime gradedDate = 3;   // If this is the original submission, it is the date the user submitted
    optional string whoChanged = 4;                         // UserId of the person who changed the grade
}
