<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utilities/persistantData/courseSketchDatabase.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utilities/persistantData/courseSketchDatabase.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @class SchoolDataManager
 * Attempts to use data as a database, pulls data from the server if it does not
 * exist
 *
 * @param {String} userId
 *            The user that this database is associated with.
 * @param {AdvanceDataListener} advanceDataListener
 *            An instance of {@link AdvanceDataListener} this is used for
 *            responses to queries made by the database server
 * @param {Connection} connection
 *            The connection to the server which will handle all connections
 *            relating to certain queries.
 * @param {Request} Request
 *            The class representing the Request protobuf used to get the
 *            message type.
 * @param {ByteBuffer} ByteBuffer
 *            The static instance that is used for encoding and decoding data.
 */
function SchoolDataManager(userId, advanceDataListener, connection, Request, ByteBuffer) {
    var LAST_UPDATE_TIME = 'LAST_UPDATE_TIME';
    var localScope = this;
    var localUserId = userId;
    var stateMachine = new Map();
    var databaseFinishedLoading = false;

    var version = 6;
    var dataListener = advanceDataListener;

    var serverConnection = connection;

    var courseManager;
    var assignmentManager;
    var courseProblemManager;
    var submissionManager;
    var lectureDataManager;
    var slideDataManager;

    var dataSender = {};

    /*
     * END OF VARIABLE SETTING
     */

    /**
     * Returns true if the database is ready false otherwise.
     *
     * it is placed this far up so that it can be called even before most of the
     * database is set up.
     */
    this.isDatabaseReady = function() {
        return databaseFinishedLoading;
    };

    /**
     * After the lower level database has been completely setup the higher level
     * specific databases can be called.
     */
    var initalizedFunction = function() {
        if (!localScope.start) {
            var intervalVar = setInterval(function() {
                if (localScope.start) {
                    console.log('Checking if higher database is truly ready!');
                    clearInterval(intervalVar);
                    localScope.start();
                }
            }, 100);
        } else {
            localScope.start();
        }
    };

    var database = new ProtoDatabase(localUserId, version, initalizedFunction);

    (function() {

        var addFunction = function(store, objectId, objectToAdd) {
            return store.put({
                'id': objectId,
                'data': objectToAdd
            });
        };

        var tables = [];
        tables.push(database.createTable('Courses', 'id', addFunction));
        tables.push(database.createTable('Assignments', 'id', addFunction));
        tables.push(database.createTable('CourseProblems', 'id', addFunction));
        tables.push(database.createTable('BankProblems', 'id', addFunction));
        tables.push(database.createTable('Submissions', 'id', addFunction));
        tables.push(database.createTable('Grades', 'id', addFunction));
        tables.push(database.createTable('Lectures', 'id', addFunction));
        tables.push(database.createTable('Slides', 'id', addFunction));
        tables.push(database.createTable('Other', 'id', addFunction));

        database.setTables(tables);
        database.open();
    })();

    /**
     * Sends a request to retrive data from the server.
     */
    dataSender.sendDataRequest = function sendDataRequest(queryType, idList, advanceQuery) {
        var dataSend = CourseSketch.PROTOBUF_UTIL.DataRequest();
        dataSend.items = [];
        var itemRequest = CourseSketch.PROTOBUF_UTIL.ItemRequest();
        itemRequest.setQuery(queryType);

        if (!isUndefined(idList)) {
            itemRequest.setItemId(idList);
        }
        if (!isUndefined(advanceQuery)) {
            itemRequest.setAdvanceQuery(advanceQuery.toArrayBuffer());
        }
        dataSend.items.push(itemRequest);
        serverConnection.sendRequest(CourseSketch.PROTOBUF_UTIL.createRequestFromData(dataSend, Request.MessageType.DATA_REQUEST));
    };

    /**
     * Inserts data into the server database.
     */
    dataSender.sendDataInsert = function sendDataInsert(queryType, data) {
        var dataSend = CourseSketch.PROTOBUF_UTIL.DataSend();
        dataSend.items = [];
        var itemSend = CourseSketch.PROTOBUF_UTIL.ItemSend();
        itemSend.setQuery(queryType);
        itemSend.setData(data);
        dataSend.items.push(itemSend);

        serverConnection.sendRequest(CourseSketch.PROTOBUF_UTIL.createRequestFromData(dataSend, Request.MessageType.DATA_INSERT));
    };

    /**
     * Sends an update to the server for the data to be updated.
     */
    dataSender.sendDataUpdate = function sendDataUpdate(queryType, data) {
        var dataSend = CourseSketch.PROTOBUF_UTIL.DataSend();
        dataSend.items = [];
        var itemUpdate = CourseSketch.PROTOBUF_UTIL.ItemSend();
        itemUpdate.setQuery(queryType);
        itemUpdate.setData(data);
        dataSend.items.push(itemUpdate);

        serverConnection.sendRequest(CourseSketch.PROTOBUF_UTIL.createRequestFromData(dataSend, Request.MessageType.DATA_UPDATE));
    };

    this.emptySchoolData = function() {
        database.emptySelf();
    };

    this.start = function() {
        // creates a manager for just courses.
        courseManager = new CourseDataManager(this, dataListener, database, dataSender, Request, ByteBuffer);
        assignmentManager = new AssignmentDataManager(this, dataListener, database, dataSender, Request, ByteBuffer);
        courseProblemManager = new CourseProblemDataManager(this, dataListener, database, dataSender, Request, ByteBuffer);
        submissionManager = new SubmissionDataManager(this, dataListener, database, dataSender, Request, ByteBuffer);
        lectureDataManager = new LectureDataManager(this, dataListener, database, dataSender, Request, ByteBuffer);
        slideDataManager = new SlideDataManager(this, dataListener, database, dataSender, Request, ByteBuffer);

        console.log('Database is ready for use! with user: ' + userId);
        databaseFinishedLoading = true;
    };

    /**
     * retrieves all the assignments for a given course.
     *
     * The callback is called with a list of assignment objects
     */
    this.getAllAssignmentsFromCourse = function(courseId, assignmentCallback) {
        var getAssignments = this.getAssignments;
        this.getCourse(courseId, function(course) {
            if (isUndefined(course)) {
                throw new Error('Course not defined');
            }
            if (course.assignmentList.length &lt;= 0) {
                assignmentCallback([]);
            }
            getAssignments(course.assignmentList, assignmentCallback);
        });
    };

    /**
     * retrieves all the assignments for a given course.
     *
     * The callback is called with a list of assignment objects
     */
    this.getAllProblemsFromAssignment = function(assignmentId, problemCallback) {
        var getCourseProblems = this.getCourseProblems;
        this.getAssignment(assignmentId, function(assignment) {
            if (isUndefined(assignment)) {
                throw new Error('Assignment not defined');
            }
            getCourseProblems(assignment.problemList, problemCallback);
        });
    };

    /**
     * Polls the server for updates, after all items
     */
    this.pollUpdates = function(callback) {
        database.getFromOther(LAST_UPDATE_TIME, function(e, request, result) {
            if (isUndefined(result) || isUndefined(result.data)) {
                dataSender.sendDataRequest(CourseSketch.PROTOBUF_UTIL.ItemQuery.UPDATE);
            } else {
                var lastTime = result.data;
                dataSender.sendDataRequest(CourseSketch.PROTOBUF_UTIL.ItemQuery.UPDATE, [ lastTime ]);
            }
        });
        var functionCalled = false;
        var timeout = setTimeout(function() {
            if (!functionCalled &amp;&amp; callback) {
                functionCalled = true;
                callback();
            }
        }, 5000);

        advanceDataListener.setListener(Request.MessageType.DATA_REQUEST, CourseSketch.PROTOBUF_UTIL.ItemQuery.UPDATE, function(evt, item) {
            // to store for later recall
            database.putInOther(LAST_UPDATE_TIME, connection.getCurrentTime().toString());
            clearTimeout(timeout);
            var school = CourseSketch.PROTOBUF_UTIL.getSrlSchoolClass().decode(item.data);
            var courseList = school.courses;
            for (var i = 0; i &lt; courseList.length; i++) {
                localScope.setCourse(courseList[i]);
            }

            var assignmentList = school.assignments;
            for (i = 0; i &lt; assignmentList.length; i++) {
                localScope.setAssignment(assignmentList[i]);
            }

            var problemList = school.problems;
            for (i = 0; i &lt; problemList.length; i++) {
                localScope.setCourseProblem(problemList[i]);
            }

            if (!functionCalled &amp;&amp; callback) {
                functionCalled = true;
                callback();
            }
        });
    };

    /**
     * Adds the ability to set and remove state objects (for the use of
     * transitioning from one page to the next!)
     */
    this.addState = function(key, value) {
        stateMachine.set(key, value);
    };

    this.getState = function(key) {
        return stateMachine.get(key);
    };

    this.hasState = function(key) {
        return stateMachine.has(key);
    };

    this.clearStates = function() {
        stateMachine = new Map();
    };

    /**
     * Returns the current id that is being used with the database
     */
    this.getCurrentId = function() {
        return localUserId;
    };

    this.getCurrentTime = connection.getCurrentTime;

    CourseSketch.DatabaseException = DatabaseException;

    /**
     * A helper function for testing that waits for the database to be loaded before calling a callback.
     * @param {Function} callback Called when the database is ready.
     */
    this.waitForDatabase = function waitForDatabase(callback) {
        var localScope = this;
        var interval = setInterval(function() {
            if (localScope.isDatabaseReady()) {
                clearInterval(interval);
                callback();
            } // Endif
        }, 50);
    };
}
var CURRENT_QUESTION = 'CURRENT_QUESTION';
var CURRENT_ASSIGNMENT = 'CURRENT_ASSIGNMENT';
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseException.html">BaseException</a></li><li><a href="CommandException.html">CommandException</a></li><li><a href="DatabaseException.html">DatabaseException</a></li><li><a href="Graphics.html">Graphics</a></li><li><a href="LoginSystem.html">LoginSystem</a></li><li><a href="NavigationPanel.html">NavigationPanel</a></li><li><a href="ProblemNavigator.html">ProblemNavigator</a></li><li><a href="ProtobufSetup.html">ProtobufSetup</a></li><li><a href="ProtoDatabase.html">ProtoDatabase</a></li><li><a href="Redirector.html">Redirector</a></li><li><a href="RegisterSystem.html">RegisterSystem</a></li><li><a href="SchoolDataManager.html">SchoolDataManager</a></li><li><a href="SchoolItem.html">SchoolItem</a></li><li><a href="SketchSurface.html">SketchSurface</a></li><li><a href="UndoRedoException.html">UndoRedoException</a></li><li><a href="UpdateException.html">UpdateException</a></li><li><a href="UpdateManager.html">UpdateManager</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addAnswer">addAnswer</a></li><li><a href="global.html#addAnswerContent">addAnswerContent</a></li><li><a href="global.html#addCallback">addCallback</a></li><li><a href="global.html#addClickFunction">addClickFunction</a></li><li><a href="global.html#addEventMapping">addEventMapping</a></li><li><a href="global.html#addSynchronousUpdate">addSynchronousUpdate</a></li><li><a href="global.html#addToolArea">addToolArea</a></li><li><a href="global.html#addUpdate">addUpdate</a></li><li><a href="global.html#AdvanceDataListener">AdvanceDataListener</a></li><li><a href="global.html#ArrayException">ArrayException</a></li><li><a href="global.html#assignValues">assignValues</a></li><li><a href="global.html#build">build</a></li><li><a href="global.html#buildExpandEvent">buildExpandEvent</a></li><li><a href="global.html#buildOverlay">buildOverlay</a></li><li><a href="global.html#buildPercent">buildPercent</a></li><li><a href="global.html#buildWaitIcon">buildWaitIcon</a></li><li><a href="global.html#CallbackBarrier">CallbackBarrier</a></li><li><a href="global.html#checkOverflow">checkOverflow</a></li><li><a href="global.html#clearCallbacks">clearCallbacks</a></li><li><a href="global.html#clearUpdates">clearUpdates</a></li><li><a href="global.html#close">close</a></li><li><a href="global.html#Connection">Connection</a></li><li><a href="global.html#continueButton">continueButton</a></li><li><a href="global.html#correctSize">correctSize</a></li><li><a href="global.html#CourseSketch">CourseSketch</a></li><li><a href="global.html#createBarrier">createBarrier</a></li><li><a href="global.html#createButton">createButton</a></li><li><a href="global.html#createFancySchoolItem">createFancySchoolItem</a></li><li><a href="global.html#createMarker">createMarker</a></li><li><a href="global.html#createNewPath">createNewPath</a></li><li><a href="global.html#createSchoolList">createSchoolList</a></li><li><a href="global.html#createSketch">createSketch</a></li><li><a href="global.html#createTable">createTable</a></li><li><a href="global.html#deleteSketch">deleteSketch</a></li><li><a href="global.html#detachedCallback">detachedCallback</a></li><li><a href="global.html#EmbeddedHtml">EmbeddedHtml</a></li><li><a href="global.html#emptyQueue">emptyQueue</a></li><li><a href="global.html#endPath">endPath</a></li><li><a href="global.html#executeEvent">executeEvent</a></li><li><a href="global.html#fillCanvas">fillCanvas</a></li><li><a href="global.html#finalize">finalize</a></li><li><a href="global.html#getCleanUpdateList">getCleanUpdateList</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#getCurrentAssignment">getCurrentAssignment</a></li><li><a href="global.html#getCurrentNumber">getCurrentNumber</a></li><li><a href="global.html#getCurrentProblemId">getCurrentProblemId</a></li><li><a href="global.html#getCurrentSketch">getCurrentSketch</a></li><li><a href="global.html#getCurrentTime">getCurrentTime</a></li><li><a href="global.html#getCurrentUpdate">getCurrentUpdate</a></li><li><a href="global.html#getFinishedCallback">getFinishedCallback</a></li><li><a href="global.html#getHostElement">getHostElement</a></li><li><a href="global.html#getLength">getLength</a></li><li><a href="global.html#getListLength">getListLength</a></li><li><a href="global.html#getPaper">getPaper</a></li><li><a href="global.html#getProblemText">getProblemText</a></li><li><a href="global.html#getProblemType">getProblemType</a></li><li><a href="global.html#getSketch">getSketch</a></li><li><a href="global.html#getSupportedEnums">getSupportedEnums</a></li><li><a href="global.html#getSupportedObjects">getSupportedObjects</a></li><li><a href="global.html#getUpdateList">getUpdateList</a></li><li><a href="global.html#GivenanSrlUpdateaRequestiscreated.">Given an SrlUpdate a Request is created.</a></li><li><a href="global.html#gotoNext">gotoNext</a></li><li><a href="global.html#goToNextSlide">goToNextSlide</a></li><li><a href="global.html#gotoPrevious">gotoPrevious</a></li><li><a href="global.html#goToProblem">goToProblem</a></li><li><a href="global.html#hasNext">hasNext</a></li><li><a href="global.html#hasPrevious">hasPrevious</a></li><li><a href="global.html#HighlightText">HighlightText</a></li><li><a href="global.html#ImageBox">ImageBox</a></li><li><a href="global.html#IndexManager">IndexManager</a></li><li><a href="global.html#Inheritssetsupinheritanceforfunctionsthis.Inherits(SuperClass);//supercallinsideobjectANDSubClass.Inherits(SuperClass);">Inherits
sets up inheritance for functions

this.Inherits(SuperClass); // super call inside object AND
SubClass.Inherits(SuperClass);</a></li><li><a href="global.html#initializeCanvas">initializeCanvas</a></li><li><a href="global.html#initializeElement">initializeElement</a></li><li><a href="global.html#InputListener">InputListener</a></li><li><a href="global.html#isConnected">isConnected</a></li><li><a href="global.html#isDataLoaded">isDataLoaded</a></li><li><a href="global.html#isDescriptionOverflow">isDescriptionOverflow</a></li><li><a href="global.html#isLastUpdateSave">isLastUpdateSave</a></li><li><a href="global.html#isLastUpdateSubmission">isLastUpdateSubmission</a></li><li><a href="global.html#isValidForSaving">isValidForSaving</a></li><li><a href="global.html#isValidForSubmission">isValidForSubmission</a></li><li><a href="global.html#loadData">loadData</a></li><li><a href="global.html#loadLectures">loadLectures</a></li><li><a href="global.html#loadSketch">loadSketch</a></li><li><a href="global.html#loadSlides">loadSlides</a></li><li><a href="global.html#MultiChoice">MultiChoice</a></li><li><a href="global.html#Playback">Playback</a></li><li><a href="global.html#ProblemToolBar">ProblemToolBar</a></li><li><a href="global.html#Question">Question</a></li><li><a href="global.html#reconnect">reconnect</a></li><li><a href="global.html#redoAction">redoAction</a></li><li><a href="global.html#refresh">refresh</a></li><li><a href="global.html#reloadAssignment">reloadAssignment</a></li><li><a href="global.html#reloadProblems">reloadProblems</a></li><li><a href="global.html#removeAnswer">removeAnswer</a></li><li><a href="global.html#removeCallback">removeCallback</a></li><li><a href="global.html#removeEventMapping">removeEventMapping</a></li><li><a href="global.html#removeItem">removeItem</a></li><li><a href="global.html#removeListener">removeListener</a></li><li><a href="global.html#resetValues">resetValues</a></li><li><a href="global.html">runCommand
Runs a specific command given its lastUpdateType.</a></li><li><a href="global.html#saveData">saveData</a></li><li><a href="global.html#SchoolItemBuilder">SchoolItemBuilder</a></li><li><a href="global.html#sendlocalScope">sendlocalScope</a></li><li><a href="global.html#sendRequest">sendRequest</a></li><li><a href="global.html#setAssignmentId">setAssignmentId</a></li><li><a href="global.html#setBoxState">setBoxState</a></li><li><a href="global.html#setCancelCallbackThecallbackiscalledwhentheregisterbuttonispressed.">setCancelCallback
The callback is called when the register button is pressed.</a></li><li><a href="global.html#setCorrectAnswer">setCorrectAnswer</a></li><li><a href="global.html#setCurrentSketch">setCurrentSketch</a></li><li><a href="global.html#setDrawUpdate">setDrawUpdate</a></li><li><a href="global.html#setEditCallback">setEditCallback</a></li><li><a href="global.html#setLastSaveTime">setLastSaveTime</a></li><li><a href="global.html#setListener">setListener</a></li><li><a href="global.html#setListeners">setListeners</a></li><li><a href="global.html#setOnSuccessLoginThecallbackiscalledwithoneparameter.">setOnSuccessLogin
The callback is called with one parameter.</a></li><li><a href="global.html#setParentSketch">setParentSketch</a></li><li><a href="global.html#setParentSketchId">setParentSketchId</a></li><li><a href="global.html#setPreferredIndex">setPreferredIndex</a></li><li><a href="global.html#setPreviewText">setPreviewText</a></li><li><a href="global.html#setRedoCallback">setRedoCallback</a></li><li><a href="global.html#setRegisterCallbackThecallbackiscalledwhentheregisterbuttonispressed.">setRegisterCallback
The callback is called when the register button is pressed.</a></li><li><a href="global.html#setRemoveFunction">setRemoveFunction</a></li><li><a href="global.html#setSaveCallback">setSaveCallback</a></li><li><a href="global.html#setSketch">setSketch</a></li><li><a href="global.html#setSketchClickedFunction">setSketchClickedFunction</a></li><li><a href="global.html#setSketchManager">setSketchManager</a></li><li><a href="global.html#setSubmissionInformation">setSubmissionInformation</a></li><li><a href="global.html#setSubmitCallback">setSubmitCallback</a></li><li><a href="global.html#setUiLoaded">setUiLoaded</a></li><li><a href="global.html#setUndoCallback">setUndoCallback</a></li><li><a href="global.html#setupAttributes">setupAttributes</a></li><li><a href="global.html#setupCallbacksSetupsupthecallbackfortheregisterbuttonandthelostpasswordbutton.">setupCallbacks
Setups up the callback for the register button and the lost password button.</a></li><li><a href="global.html#setUpdateList">setUpdateList</a></li><li><a href="global.html#setUpdateTime">setUpdateTime</a></li><li><a href="global.html#setUpEditButtons">setUpEditButtons</a></li><li><a href="global.html#setWrapperFunction">setWrapperFunction</a></li><li><a href="global.html#showFormattedDate">showFormattedDate</a></li><li><a href="global.html#SketchSurfaceManager">SketchSurfaceManager</a></li><li><a href="global.html#speakText">speakText</a></li><li><a href="global.html#SubmissionPanel">SubmissionPanel</a></li><li><a href="global.html#TextBox">TextBox</a></li><li><a href="global.html#TimelineMarker">TimelineMarker</a></li><li><a href="global.html#toggleSelection">toggleSelection</a></li><li><a href="global.html#undoAction">undoAction</a></li><li><a href="global.html#updatePath">updatePath</a></li><li><a href="global.html#writeTextData">writeTextData</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta2</a> on Fri Mar 13 2015 04:13:07 GMT-0500 (CDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
