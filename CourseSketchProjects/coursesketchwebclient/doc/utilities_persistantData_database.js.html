<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utilities/persistantData/database.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utilities/persistantData/database.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Creates a database with a specific name, and has a callback after being
 * opened.
 *
 * It will also create all the functions needed for the specific database.
 * @class ProtoDatabase
 */
function ProtoDatabase(databaseName, version, openCallback) {
    var databaseSupported = true;
    if (!window.indexedDB || typeof window.indexedDB === 'undefined') {
        databaseSupported = false;
        console.log('Your browser does not support a stable version of IndexedDB. So storing your data will not be possible');
        // window.alert('Your browser doesn't support a stable version of
        // IndexedDB. So storing your data will not be possible');
    }
    var localScope = this;
    var dbNameSpace = {};
    if (databaseSupported) {
        dbNameSpace.indexedDB = window.indexedDB;
    } else {
        dbNameSpace.indexedDB = undefined;
    }

    var upgradeTables = null;
    this.setTables = function(tables) {
        upgradeTables = tables;
    };

    /**
     * Returns an object that can be converted to a table.
     *
     * The table contains an addingFunction (other) and a generic callback.&lt;br>
     * example addingFunction&lt;br>
     * &lt;code>
     * function adding(store, todoText) {
     *         return store.put({
     *             'text': todoText,
     *             'timeStamp' : new Date().getTime()
     *         });
     * }
     * &lt;/code>
     *
     * @param {String} tableName
     *            The name of the specific table to be created.
     * @param {String} keyValue
     *            This is the key for that specific table
     * @param {Function} addingFunction
     *            Takes in a store and then creates and returns a request see
     *            sample above.
     */
    this.createTable = function(tableName, keyValue, addingFunction) {
        return {
            name: tableName,
            key: keyValue,
            add: addingFunction
        };
    };

    this.open = function() {
        var tableCreationCalled = false;
        try {
            // Lets do browser checking for compatability.
            var request = indexedDB.open(databaseName, version);

            // We can only create Object stores in a version change transaction.
            request.onupgradeneeded = function(e) {
                var db = e.target.result;
                // A versionchange transaction is started automatically.
                e.target.transaction.onerror = dbNameSpace.indexedDB.onerror;
                for (var i = 0; i &lt; upgradeTables.length; i++) {
                    table = upgradeTables[i];
                    // delete existing table
                    if (db.objectStoreNames.contains(table.name)) {
                        db.deleteObjectStore(table.name);
                    }
                    var store = db.createObjectStore(table.name, { keyPath: table.key });
                }
            };
            request.onsuccess = function(e) {
                console.log('Database has opened');
                dbNameSpace.indexedDB.db = e.target.result;
                if (!tableCreationCalled) {
                    tableCreationCalled = true;
                    createTableFunctions();
                }
            };
            request.onerror = function(e) {
                console.log(e);
                console.log('Exception has occured when getting data');
                // if there is an exception then we should continue
                dbNameSpace.indexedDB = null;
                if (!tableCreationCalled) {
                    tableCreationCalled = true;
                    createTableFunctions();
                }
            };
        } catch (exception) {
            console.error(exception);
            // if there is an exception then we should continue
            dbNameSpace.indexedDB = null;
            if (!tableCreationCalled) {
                tableCreationCalled = true;
                createTableFunctions();
            }
        }
    };

    /**
     * creates a bunch of functions for the table which are created upon
     * successful database creation.
     */
    function createTableFunctions() {
        if (upgradeTables === null) {
            if (openCallback) {
                openCallback();
            }
            return;
        }
        for (var i = 0; i &lt; upgradeTables.length; i++) {
            table = upgradeTables[i];
            (function(localTable) {
                /**
                 * Creates a function for adding items to the database.
                 */
                localScope[ 'putIn' + localTable.name ] = function(objectId, objectToAdd, callback) {
                    if (!databaseSupported || !dbNameSpace.indexedDB) {
                        return; // fail silently
                    }

                    var db = dbNameSpace.indexedDB.db;
                    var trans = db.transaction([ localTable.name ], 'readwrite');
                    var store = trans.objectStore(localTable.name);
                    var request = localTable.add(store, objectId, objectToAdd);
                    trans.oncomplete = function(e) {
                        // add objectId to some sort of id list so we know what
                        // data is contained
                        // this data is only to be used for the local deletion
                        // of all items in the database
                        if (callback) {
                            callback(e, request);
                        }
                    };

                    request.onerror = function(e) {
                        console.log(e.value);
                    };
                };

                /**
                 * Creates a function for deleting items from the database.
                 */
                localScope[ 'deleteFrom' + localTable.name ] = function(objectId, callback) {
                    if (!databaseSupported || !dbNameSpace.indexedDB || !dbNameSpace.indexedDB.db) {
                        return; // fail silently
                    }

                    var db = dbNameSpace.indexedDB.db;
                    var trans = db.transaction([ localTable.name ], 'readwrite');
                    var store = trans.objectStore(localTable.name);
                    var request = store.delete(objectId);
                    trans.oncomplete = function(e) {
                        if (!isUndefined(callback)) {
                            callback(e, request);
                        }
                    };

                    request.onerror = function(e) {
                        console.log(e.value);
                    };
                };

                /**
                 * Creates a function for deleting items from the database.
                 */
                localScope[ 'getFrom' + localTable.name ] = function(objectId, callback) {
                    if (!databaseSupported || !dbNameSpace.indexedDB) {
                        // return undefined
                        callback(undefined, undefined, undefined);
                        return;
                    }

                    var db = dbNameSpace.indexedDB.db;
                    var trans = db.transaction([ localTable.name ]);
                    var store = trans.objectStore(localTable.name);
                    var request = store.get(objectId);
                    request.onsuccess = function(e) {
                        if (callback) {
                            callback(e, request, request.result);
                        }
                    };

                    request.onerror = function(e) {
                        console.log(e.value);
                    };
                };
            })(table);
        }
        if (openCallback) {
            openCallback();
        }
    }

    this.emptySelf = function() {
        emptyDB(databaseName);
    };

    function emptyDB(databaseName) {
        try {
            var result = confirm('Do you want to empty all of the local data?');
            if (result === true) {
                var dbreq = dbNameSpace.indexedDB.deleteDatabase(databaseName);
                dbreq.onsuccess = function(event) {
                    output_trace('indexedDB: ' + databaseName + ' deleted');
                };
                dbreq.onerror = function(event) {
                    output_trace('indexedDB.delete Error: ' + event.message);
                };
            } else {
                alert('The local data was not emptied');
            }
        } catch (e) {
            output_trace('Error: ' + e.message);
        }
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseException.html">BaseException</a></li><li><a href="CommandException.html">CommandException</a></li><li><a href="DatabaseException.html">DatabaseException</a></li><li><a href="Graphics.html">Graphics</a></li><li><a href="LoginSystem.html">LoginSystem</a></li><li><a href="NavigationPanel.html">NavigationPanel</a></li><li><a href="ProblemNavigator.html">ProblemNavigator</a></li><li><a href="ProtobufSetup.html">ProtobufSetup</a></li><li><a href="ProtoDatabase.html">ProtoDatabase</a></li><li><a href="Redirector.html">Redirector</a></li><li><a href="RegisterSystem.html">RegisterSystem</a></li><li><a href="SchoolDataManager.html">SchoolDataManager</a></li><li><a href="SchoolItem.html">SchoolItem</a></li><li><a href="SketchSurface.html">SketchSurface</a></li><li><a href="UndoRedoException.html">UndoRedoException</a></li><li><a href="UpdateException.html">UpdateException</a></li><li><a href="UpdateManager.html">UpdateManager</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addAnswer">addAnswer</a></li><li><a href="global.html#addAnswerContent">addAnswerContent</a></li><li><a href="global.html#addCallback">addCallback</a></li><li><a href="global.html#addClickFunction">addClickFunction</a></li><li><a href="global.html#addEventMapping">addEventMapping</a></li><li><a href="global.html#addSynchronousUpdate">addSynchronousUpdate</a></li><li><a href="global.html#addToolArea">addToolArea</a></li><li><a href="global.html#addUpdate">addUpdate</a></li><li><a href="global.html#AdvanceDataListener">AdvanceDataListener</a></li><li><a href="global.html#ArrayException">ArrayException</a></li><li><a href="global.html#assignValues">assignValues</a></li><li><a href="global.html#build">build</a></li><li><a href="global.html#buildExpandEvent">buildExpandEvent</a></li><li><a href="global.html#buildOverlay">buildOverlay</a></li><li><a href="global.html#buildPercent">buildPercent</a></li><li><a href="global.html#buildWaitIcon">buildWaitIcon</a></li><li><a href="global.html#CallbackBarrier">CallbackBarrier</a></li><li><a href="global.html#checkOverflow">checkOverflow</a></li><li><a href="global.html#clearCallbacks">clearCallbacks</a></li><li><a href="global.html#clearUpdates">clearUpdates</a></li><li><a href="global.html#close">close</a></li><li><a href="global.html#Connection">Connection</a></li><li><a href="global.html#continueButton">continueButton</a></li><li><a href="global.html#correctSize">correctSize</a></li><li><a href="global.html#CourseSketch">CourseSketch</a></li><li><a href="global.html#createBarrier">createBarrier</a></li><li><a href="global.html#createButton">createButton</a></li><li><a href="global.html#createFancySchoolItem">createFancySchoolItem</a></li><li><a href="global.html#createMarker">createMarker</a></li><li><a href="global.html#createNewPath">createNewPath</a></li><li><a href="global.html#createSchoolList">createSchoolList</a></li><li><a href="global.html#createSketch">createSketch</a></li><li><a href="global.html#createTable">createTable</a></li><li><a href="global.html#deleteSketch">deleteSketch</a></li><li><a href="global.html#detachedCallback">detachedCallback</a></li><li><a href="global.html#EmbeddedHtml">EmbeddedHtml</a></li><li><a href="global.html#emptyQueue">emptyQueue</a></li><li><a href="global.html#endPath">endPath</a></li><li><a href="global.html#executeEvent">executeEvent</a></li><li><a href="global.html#fillCanvas">fillCanvas</a></li><li><a href="global.html#finalize">finalize</a></li><li><a href="global.html#getCleanUpdateList">getCleanUpdateList</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#getCurrentAssignment">getCurrentAssignment</a></li><li><a href="global.html#getCurrentNumber">getCurrentNumber</a></li><li><a href="global.html#getCurrentProblemId">getCurrentProblemId</a></li><li><a href="global.html#getCurrentSketch">getCurrentSketch</a></li><li><a href="global.html#getCurrentTime">getCurrentTime</a></li><li><a href="global.html#getCurrentUpdate">getCurrentUpdate</a></li><li><a href="global.html#getFinishedCallback">getFinishedCallback</a></li><li><a href="global.html#getHostElement">getHostElement</a></li><li><a href="global.html#getLength">getLength</a></li><li><a href="global.html#getListLength">getListLength</a></li><li><a href="global.html#getPaper">getPaper</a></li><li><a href="global.html#getProblemText">getProblemText</a></li><li><a href="global.html#getProblemType">getProblemType</a></li><li><a href="global.html#getSketch">getSketch</a></li><li><a href="global.html#getSupportedEnums">getSupportedEnums</a></li><li><a href="global.html#getSupportedObjects">getSupportedObjects</a></li><li><a href="global.html#getUpdateList">getUpdateList</a></li><li><a href="global.html#GivenanSrlUpdateaRequestiscreated.">Given an SrlUpdate a Request is created.</a></li><li><a href="global.html#gotoNext">gotoNext</a></li><li><a href="global.html#goToNextSlide">goToNextSlide</a></li><li><a href="global.html#gotoPrevious">gotoPrevious</a></li><li><a href="global.html#goToProblem">goToProblem</a></li><li><a href="global.html#hasNext">hasNext</a></li><li><a href="global.html#hasPrevious">hasPrevious</a></li><li><a href="global.html#HighlightText">HighlightText</a></li><li><a href="global.html#ImageBox">ImageBox</a></li><li><a href="global.html#IndexManager">IndexManager</a></li><li><a href="global.html#Inheritssetsupinheritanceforfunctionsthis.Inherits(SuperClass);//supercallinsideobjectANDSubClass.Inherits(SuperClass);">Inherits
sets up inheritance for functions

this.Inherits(SuperClass); // super call inside object AND
SubClass.Inherits(SuperClass);</a></li><li><a href="global.html#initializeCanvas">initializeCanvas</a></li><li><a href="global.html#initializeElement">initializeElement</a></li><li><a href="global.html#InputListener">InputListener</a></li><li><a href="global.html#isConnected">isConnected</a></li><li><a href="global.html#isDataLoaded">isDataLoaded</a></li><li><a href="global.html#isDescriptionOverflow">isDescriptionOverflow</a></li><li><a href="global.html#isLastUpdateSave">isLastUpdateSave</a></li><li><a href="global.html#isLastUpdateSubmission">isLastUpdateSubmission</a></li><li><a href="global.html#isValidForSaving">isValidForSaving</a></li><li><a href="global.html#isValidForSubmission">isValidForSubmission</a></li><li><a href="global.html#loadData">loadData</a></li><li><a href="global.html#loadLectures">loadLectures</a></li><li><a href="global.html#loadSketch">loadSketch</a></li><li><a href="global.html#loadSlides">loadSlides</a></li><li><a href="global.html#MultiChoice">MultiChoice</a></li><li><a href="global.html#Playback">Playback</a></li><li><a href="global.html#ProblemToolBar">ProblemToolBar</a></li><li><a href="global.html#Question">Question</a></li><li><a href="global.html#reconnect">reconnect</a></li><li><a href="global.html#redoAction">redoAction</a></li><li><a href="global.html#refresh">refresh</a></li><li><a href="global.html#reloadAssignment">reloadAssignment</a></li><li><a href="global.html#reloadProblems">reloadProblems</a></li><li><a href="global.html#removeAnswer">removeAnswer</a></li><li><a href="global.html#removeCallback">removeCallback</a></li><li><a href="global.html#removeEventMapping">removeEventMapping</a></li><li><a href="global.html#removeItem">removeItem</a></li><li><a href="global.html#removeListener">removeListener</a></li><li><a href="global.html#resetValues">resetValues</a></li><li><a href="global.html">runCommand
Runs a specific command given its lastUpdateType.</a></li><li><a href="global.html#saveData">saveData</a></li><li><a href="global.html#SchoolItemBuilder">SchoolItemBuilder</a></li><li><a href="global.html#sendlocalScope">sendlocalScope</a></li><li><a href="global.html#sendRequest">sendRequest</a></li><li><a href="global.html#setAssignmentId">setAssignmentId</a></li><li><a href="global.html#setBoxState">setBoxState</a></li><li><a href="global.html#setCancelCallbackThecallbackiscalledwhentheregisterbuttonispressed.">setCancelCallback
The callback is called when the register button is pressed.</a></li><li><a href="global.html#setCorrectAnswer">setCorrectAnswer</a></li><li><a href="global.html#setCurrentSketch">setCurrentSketch</a></li><li><a href="global.html#setDrawUpdate">setDrawUpdate</a></li><li><a href="global.html#setEditCallback">setEditCallback</a></li><li><a href="global.html#setLastSaveTime">setLastSaveTime</a></li><li><a href="global.html#setListener">setListener</a></li><li><a href="global.html#setListeners">setListeners</a></li><li><a href="global.html#setOnSuccessLoginThecallbackiscalledwithoneparameter.">setOnSuccessLogin
The callback is called with one parameter.</a></li><li><a href="global.html#setParentSketch">setParentSketch</a></li><li><a href="global.html#setParentSketchId">setParentSketchId</a></li><li><a href="global.html#setPreferredIndex">setPreferredIndex</a></li><li><a href="global.html#setPreviewText">setPreviewText</a></li><li><a href="global.html#setRedoCallback">setRedoCallback</a></li><li><a href="global.html#setRegisterCallbackThecallbackiscalledwhentheregisterbuttonispressed.">setRegisterCallback
The callback is called when the register button is pressed.</a></li><li><a href="global.html#setRemoveFunction">setRemoveFunction</a></li><li><a href="global.html#setSaveCallback">setSaveCallback</a></li><li><a href="global.html#setSketch">setSketch</a></li><li><a href="global.html#setSketchClickedFunction">setSketchClickedFunction</a></li><li><a href="global.html#setSketchManager">setSketchManager</a></li><li><a href="global.html#setSubmissionInformation">setSubmissionInformation</a></li><li><a href="global.html#setSubmitCallback">setSubmitCallback</a></li><li><a href="global.html#setUiLoaded">setUiLoaded</a></li><li><a href="global.html#setUndoCallback">setUndoCallback</a></li><li><a href="global.html#setupAttributes">setupAttributes</a></li><li><a href="global.html#setupCallbacksSetupsupthecallbackfortheregisterbuttonandthelostpasswordbutton.">setupCallbacks
Setups up the callback for the register button and the lost password button.</a></li><li><a href="global.html#setUpdateList">setUpdateList</a></li><li><a href="global.html#setUpdateTime">setUpdateTime</a></li><li><a href="global.html#setUpEditButtons">setUpEditButtons</a></li><li><a href="global.html#setWrapperFunction">setWrapperFunction</a></li><li><a href="global.html#showFormattedDate">showFormattedDate</a></li><li><a href="global.html#SketchSurfaceManager">SketchSurfaceManager</a></li><li><a href="global.html#speakText">speakText</a></li><li><a href="global.html#SubmissionPanel">SubmissionPanel</a></li><li><a href="global.html#TextBox">TextBox</a></li><li><a href="global.html#TimelineMarker">TimelineMarker</a></li><li><a href="global.html#toggleSelection">toggleSelection</a></li><li><a href="global.html#undoAction">undoAction</a></li><li><a href="global.html#updatePath">updatePath</a></li><li><a href="global.html#writeTextData">writeTextData</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta2</a> on Fri Mar 13 2015 04:13:07 GMT-0500 (CDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
