<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utilities/templates/highlightText/highlightText.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utilities/templates/highlightText/highlightText.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * This class creates the highlightText dialog
 * The dialog is moveable with a color selector and checkbox for turning highlight mode on and off
 * The highlighting is done by adding span tags and will not break any formatting across other tags
 */
function HighlightText() {
    // Defined in this scope to make easer for save/Load to find shadowRoot. this.shadowRoot DNE for save/Load b/c of the parameter type
    var shadowRoot = undefined;

    /**
     * This is for making the dialog moveable with the interact.js library
     * It selects the created dialog and makes it draggable with no inertia
     * It also ignores click and drag from textareas and buttons within the dialog
     */
    function enableDragging() {
        interact(shadowRoot.querySelector('#highlightTextDialog'))
            .ignoreFrom('button')
            .draggable({
                onmove: function(event) {
                    var target = event.target;
                    var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                    var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                    target.style.webkitTransform =
                    target.style.transform =
                        'translate(' + x + 'px, ' + y + 'px)';

                    target.setAttribute('data-x', x);
                    target.setAttribute('data-y', y);
                },

            })
            .inertia(false)
            .restrict({
                drag: 'parent',
                endOnly: true,
                elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
        });
    }

    /**
     * @param {Array} children represents the childNodes in the selected text.
     * @return {Boolean} false if children contains nodes that are something other than #text or SPAN. True otherwise
     * If false then the text selected will not be highlighted
     * It will not be highlighted because it contains node types such as H2 and adding span tags will ruin the formatting of the text
     */
    function checkChildrenNodes(children) {
        for (i = 0; i &lt; children.length; i++) {
            if (children[i].nodeName !== '#text' &amp;&amp; children[i].nodeName !== 'SPAN') {
                return false;
            }
        }
        return true;
    }

    /**
     * Wraps the selected text in span tags with the color of the color selector
     * If the selection crosses elements, there is an alert to notify the user of an invalid selection
     * The selection must also contain characters (no alert for this)
     */
    function highlightText() {
        if (window.getSelection().type !== 'None') {
            var myText = window.getSelection();
            var range = myText.getRangeAt();
            children = range.cloneContents().childNodes;
            if (myText.toString().length > 0) { // Makes sure the selection contains characters so blank span tags are not added
                if (checkChildrenNodes(children)) { // Makes sure adding span tags will not ruin the selected text formatting
                    var newNode = document.createElement('span'); // This node is created to encase the text in the highlighted color
                    newNode.setAttribute('class', 'highlightedText');
                    newNode.setAttribute('style', 'background:' + this.backgroundColor + '; color:' + this.textColor);

                    // These values are used for saving data
                    this.startPath = getXPath(range.startContainer);
                    this.startOffset = range.startOffset;
                    this.endPath = getXPath(range.endContainer);
                    this.endOffset = range.endOffset;

                    newNode.appendChild(range.extractContents()); // Makes the new span tags have the contents of the selection
                    range.insertNode(newNode); // Inserts the new node to where the old range was
                    this.saveData();
                } else {
                    alert('Please make a valid selection.'); // Message for invalid selections
                }
            }
        }
    }

    /**
     * @param {Node} node is the node whose path we are getting
     * @param {String} currentPath is used within the function to append the previous sibling to the path
     * @return {String} currentPath is the XML Path of the input node
     */
    function getXPath (node, currentPath) {
        currentPath = currentPath || '';
        switch (node.nodeType) {
            case 3:
            case 4:
                return getXPath(node.parentNode, 'text()[' + (document.evaluate('preceding-sibling::text()', node, null,
                        XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null).snapshotLength + 1) + ']');
            case 1:
                return getXPath(node.parentNode, node.nodeName + '[' + (document.evaluate('preceding-sibling::' + node.nodeName, node, null,
                        XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null).snapshotLength + 1) + ']' + (currentPath ? '/' + currentPath : ''));
            case 9:
                return '/' + currentPath;
            default:
                return '';
        }
    }

    /**
     * @param {Node} templateClone is a clone of the custom HTML template for highlighting text
     * This creates the element in the shadowRoot and turns highlight mode on by default
     * It tracks changes to the color selector and to the highlight mode checkbox
     * When color selector is changed, the color variable updates.
     * When highlight checkbox is changed, the function for highlighting is bound or unbound to mouseup
     * Also enables dragging and sets the exit button to close the dialog
     */
    this.initializeElement = function(templateClone) {
        var localScope = this;
        shadowRoot = this.createShadowRoot();
        shadowRoot.appendChild(templateClone);
        if (isUndefined(this.backgroundColor)) {
            this.backgroundColor = shadowRoot.querySelector('#backgroundColor').value;
        }
        if (isUndefined(this.textColor)) {
            this.textColor = shadowRoot.querySelector('#textColor').value;
        }
        this.startPath = undefined;
        this.startOffset = undefined;
        this.endPath = undefined;
        this.endOffset = undefined;
        this.highlightProto = undefined;

        // Binds or unbinds mouseup and the highlightText function based on the state of the highlightMode checkbox
        shadowRoot.querySelector('#highlightMode').onchange = function() {
            if (shadowRoot.querySelector('#highlightMode').checked) {
                $(document).on('mouseup', highlightText.bind(this));
            } else {
                $(document).off('mouseup', highlightText.bind(this));
            }
        }.bind(this); // Binds this so the highlightText function can write to variables (this is to define the correct scope)

        // Click action for the 'X' that closes the dialog
        shadowRoot.querySelector('#closeButton').onclick = function() {
            if (confirm('You are about to permanently remove the highlighting from this step.')) {
                $(document).off('mouseup', highlightText); // Removes the bound mouseup event
                localScope.getFinishedCallback()(localScope.command, event, localScope.currentUpdate); // Gets and calls finishedCallback
            }
        };

        // Updates value of backgroundColor when the color selector value is changed by the user
        shadowRoot.querySelector('#backgroundColor').onchange = function() {
            localScope.backgroundColor = shadowRoot.querySelector('#backgroundColor').value;
        };

        // Updates value of textColor when the color selecor value is changed by the user
        shadowRoot.querySelector('#textColor').onchange = function() {
            localScope.textColor = shadowRoot.querySelector('#textColor').value;
        };

        enableDragging();
        this.loadData(this.loadedData);
    };

    this.setFinishedListener = function(listener) {
        this.finishedCallback = listener;
    };

    /**
     * This saves data for the highlight tool
     * The highlight tool only appears once per tutorial step, but multiple selections is allowed
     * highlightProto corresponds with the tool, and thus only exists once per tutorial step
     * nodePathProto is the data needed to define a selection with its highlighted color. There can be multiple per tutorial step
     */
    this.saveData = function() {
        var nodePathProto = CourseSketch.PROTOBUF_UTIL.SelectedNodePath();
        if (isUndefined(this.highlightProto)) { // Defines highlightProto if it does not already exist
            this.highlightProto = CourseSketch.PROTOBUF_UTIL.ActionCreateHighlightText();
        }
        if (!isUndefined(this.startPath)) { // If startPath is defined, then saving will occur
            nodePathProto.setStartPath(this.startPath);
            nodePathProto.setStartOffset(this.startOffset);
            nodePathProto.setEndPath(this.endPath);
            nodePathProto.setEndOffset(this.endOffset);
            nodePathProto.setBackgroundColor(this.backgroundColor);
            nodePathProto.setTextColor(this.textColor);
            this.highlightProto.add('selectedNodePath', nodePathProto); // Adds nodePath to the end of the current highlightProto list
        }

        // If the highlightText does not have an id, then a command has not been created for the highlightText
        if ((isUndefined(this.id) || this.id === null || this.id === '')) {
            this.command = CourseSketch.PROTOBUF_UTIL.createBaseCommand(CourseSketch.PROTOBUF_UTIL.CommandType.CREATE_HIGHLIGHT_TEXT, true);
        }
        this.command.setCommandData(this.highlightProto.toArrayBuffer()); // Sets commandData for commandlist
        this.createdCommand = this.command;
        this.id = this.command.commandId; // Sets highlightText id to the same as the commandId
        this.getFinishedCallback()(this.command, undefined, this.currentUpdate); // Gets finishedCallback and calls it with command as parameter
    };

    /**
     * This function loads data by recreating the node and then insert it into the webpage
     * @param {ProtoCommand} protoData is the CommandData to be loaded
     */
    this.loadData = function(protoData) {
        if (isUndefined(this.shadowRoot) || this.shadowRoot === null) {
            this.loadedData = protoData;
            return;
        }
        if (isUndefined(protoData)) {
            return;
        }
        var nodes = protoData.getSelectedNodePath(); // This is a list of all the nodes to recreate
        var backgroundColor;
        var textColor;
        this.highlightProto = protoData; // This sets highlightProto to the previous list so that you can add new selections in edit mode
        for (var i = 0; i &lt; nodes.length; i++) { // Goes through the list of nodes to recreate and recreates them
            var loadNode = nodes[i]; // The current node to be loaded
            var rangeStartNode = loadNode.getStartPath();
            var rangeStartOffset = loadNode.getStartOffset();
            var rangeEndNode = loadNode.getEndPath();
            var rangeEndOffset = loadNode.getEndOffset();
            backgroundColor = loadNode.getBackgroundColor();
            textColor = loadNode.getTextColor();

            // This recreates the node based on selection start/end node/offset and text/background colors
            if (!isUndefined(window.getSelection)) {
                var selection = window.getSelection();
                selection.removeAllRanges();
                var range = document.createRange();
                range.setStart(document.evaluate(rangeStartNode, document, null,
                        XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue, Number(rangeStartOffset));
                range.setEnd(document.evaluate(rangeEndNode, document, null,
                        XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue, Number(rangeEndOffset));
                selection.addRange(range);

                var newNode = document.createElement('span');
                newNode.setAttribute('class', 'highlightedText');
                newNode.setAttribute('style', 'background:' + backgroundColor + '; color:' + textColor);
                newNode.appendChild(range.extractContents());
                range.insertNode(newNode);
            }
        }

        // This will set the text/background color to the last used combination
        shadowRoot.querySelector('#textColor').value = textColor;
        shadowRoot.querySelector('#backgroundColor').value = backgroundColor;
        this.textColor = textColor;
        this.backgroundColor = backgroundColor;
    };

    this.getFinishedCallback = function() {
        return this.finishedCallback;
    };
}

HighlightText.prototype.finishedCallback = undefined; // Defined by whoever implements this by using setFinishedListener().
HighlightText.prototype.createdCommand = undefined;
HighlightText.prototype = Object.create(HTMLDialogElement.prototype);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseException.html">BaseException</a></li><li><a href="CommandException.html">CommandException</a></li><li><a href="DatabaseException.html">DatabaseException</a></li><li><a href="Graphics.html">Graphics</a></li><li><a href="LoginSystem.html">LoginSystem</a></li><li><a href="NavigationPanel.html">NavigationPanel</a></li><li><a href="ProblemNavigator.html">ProblemNavigator</a></li><li><a href="ProtobufSetup.html">ProtobufSetup</a></li><li><a href="ProtoDatabase.html">ProtoDatabase</a></li><li><a href="Redirector.html">Redirector</a></li><li><a href="RegisterSystem.html">RegisterSystem</a></li><li><a href="SchoolDataManager.html">SchoolDataManager</a></li><li><a href="SchoolItem.html">SchoolItem</a></li><li><a href="SketchSurface.html">SketchSurface</a></li><li><a href="UndoRedoException.html">UndoRedoException</a></li><li><a href="UpdateException.html">UpdateException</a></li><li><a href="UpdateManager.html">UpdateManager</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addAnswer">addAnswer</a></li><li><a href="global.html#addAnswerContent">addAnswerContent</a></li><li><a href="global.html#addCallback">addCallback</a></li><li><a href="global.html#addClickFunction">addClickFunction</a></li><li><a href="global.html#addEventMapping">addEventMapping</a></li><li><a href="global.html#addSynchronousUpdate">addSynchronousUpdate</a></li><li><a href="global.html#addToolArea">addToolArea</a></li><li><a href="global.html#addUpdate">addUpdate</a></li><li><a href="global.html#AdvanceDataListener">AdvanceDataListener</a></li><li><a href="global.html#ArrayException">ArrayException</a></li><li><a href="global.html#assignValues">assignValues</a></li><li><a href="global.html#build">build</a></li><li><a href="global.html#buildExpandEvent">buildExpandEvent</a></li><li><a href="global.html#buildOverlay">buildOverlay</a></li><li><a href="global.html#buildPercent">buildPercent</a></li><li><a href="global.html#buildWaitIcon">buildWaitIcon</a></li><li><a href="global.html#CallbackBarrier">CallbackBarrier</a></li><li><a href="global.html#checkOverflow">checkOverflow</a></li><li><a href="global.html#clearCallbacks">clearCallbacks</a></li><li><a href="global.html#clearUpdates">clearUpdates</a></li><li><a href="global.html#close">close</a></li><li><a href="global.html#Connection">Connection</a></li><li><a href="global.html#continueButton">continueButton</a></li><li><a href="global.html#correctSize">correctSize</a></li><li><a href="global.html#CourseSketch">CourseSketch</a></li><li><a href="global.html#createBarrier">createBarrier</a></li><li><a href="global.html#createButton">createButton</a></li><li><a href="global.html#createFancySchoolItem">createFancySchoolItem</a></li><li><a href="global.html#createMarker">createMarker</a></li><li><a href="global.html#createNewPath">createNewPath</a></li><li><a href="global.html#createSchoolList">createSchoolList</a></li><li><a href="global.html#createSketch">createSketch</a></li><li><a href="global.html#createTable">createTable</a></li><li><a href="global.html#deleteSketch">deleteSketch</a></li><li><a href="global.html#detachedCallback">detachedCallback</a></li><li><a href="global.html#EmbeddedHtml">EmbeddedHtml</a></li><li><a href="global.html#emptyQueue">emptyQueue</a></li><li><a href="global.html#endPath">endPath</a></li><li><a href="global.html#executeEvent">executeEvent</a></li><li><a href="global.html#fillCanvas">fillCanvas</a></li><li><a href="global.html#finalize">finalize</a></li><li><a href="global.html#getCleanUpdateList">getCleanUpdateList</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#getCurrentAssignment">getCurrentAssignment</a></li><li><a href="global.html#getCurrentNumber">getCurrentNumber</a></li><li><a href="global.html#getCurrentProblemId">getCurrentProblemId</a></li><li><a href="global.html#getCurrentSketch">getCurrentSketch</a></li><li><a href="global.html#getCurrentTime">getCurrentTime</a></li><li><a href="global.html#getCurrentUpdate">getCurrentUpdate</a></li><li><a href="global.html#getFinishedCallback">getFinishedCallback</a></li><li><a href="global.html#getHostElement">getHostElement</a></li><li><a href="global.html#getLength">getLength</a></li><li><a href="global.html#getListLength">getListLength</a></li><li><a href="global.html#getPaper">getPaper</a></li><li><a href="global.html#getProblemText">getProblemText</a></li><li><a href="global.html#getProblemType">getProblemType</a></li><li><a href="global.html#getSketch">getSketch</a></li><li><a href="global.html#getSupportedEnums">getSupportedEnums</a></li><li><a href="global.html#getSupportedObjects">getSupportedObjects</a></li><li><a href="global.html#getUpdateList">getUpdateList</a></li><li><a href="global.html#GivenanSrlUpdateaRequestiscreated.">Given an SrlUpdate a Request is created.</a></li><li><a href="global.html#gotoNext">gotoNext</a></li><li><a href="global.html#goToNextSlide">goToNextSlide</a></li><li><a href="global.html#gotoPrevious">gotoPrevious</a></li><li><a href="global.html#goToProblem">goToProblem</a></li><li><a href="global.html#hasNext">hasNext</a></li><li><a href="global.html#hasPrevious">hasPrevious</a></li><li><a href="global.html#HighlightText">HighlightText</a></li><li><a href="global.html#ImageBox">ImageBox</a></li><li><a href="global.html#IndexManager">IndexManager</a></li><li><a href="global.html#Inheritssetsupinheritanceforfunctionsthis.Inherits(SuperClass);//supercallinsideobjectANDSubClass.Inherits(SuperClass);">Inherits
sets up inheritance for functions

this.Inherits(SuperClass); // super call inside object AND
SubClass.Inherits(SuperClass);</a></li><li><a href="global.html#initializeCanvas">initializeCanvas</a></li><li><a href="global.html#initializeElement">initializeElement</a></li><li><a href="global.html#InputListener">InputListener</a></li><li><a href="global.html#isConnected">isConnected</a></li><li><a href="global.html#isDataLoaded">isDataLoaded</a></li><li><a href="global.html#isDescriptionOverflow">isDescriptionOverflow</a></li><li><a href="global.html#isLastUpdateSave">isLastUpdateSave</a></li><li><a href="global.html#isLastUpdateSubmission">isLastUpdateSubmission</a></li><li><a href="global.html#isValidForSaving">isValidForSaving</a></li><li><a href="global.html#isValidForSubmission">isValidForSubmission</a></li><li><a href="global.html#loadData">loadData</a></li><li><a href="global.html#loadLectures">loadLectures</a></li><li><a href="global.html#loadSketch">loadSketch</a></li><li><a href="global.html#loadSlides">loadSlides</a></li><li><a href="global.html#MultiChoice">MultiChoice</a></li><li><a href="global.html#Playback">Playback</a></li><li><a href="global.html#ProblemToolBar">ProblemToolBar</a></li><li><a href="global.html#Question">Question</a></li><li><a href="global.html#reconnect">reconnect</a></li><li><a href="global.html#redoAction">redoAction</a></li><li><a href="global.html#refresh">refresh</a></li><li><a href="global.html#reloadAssignment">reloadAssignment</a></li><li><a href="global.html#reloadProblems">reloadProblems</a></li><li><a href="global.html#removeAnswer">removeAnswer</a></li><li><a href="global.html#removeCallback">removeCallback</a></li><li><a href="global.html#removeEventMapping">removeEventMapping</a></li><li><a href="global.html#removeItem">removeItem</a></li><li><a href="global.html#removeListener">removeListener</a></li><li><a href="global.html#resetValues">resetValues</a></li><li><a href="global.html">runCommand
Runs a specific command given its lastUpdateType.</a></li><li><a href="global.html#saveData">saveData</a></li><li><a href="global.html#SchoolItemBuilder">SchoolItemBuilder</a></li><li><a href="global.html#sendlocalScope">sendlocalScope</a></li><li><a href="global.html#sendRequest">sendRequest</a></li><li><a href="global.html#setAssignmentId">setAssignmentId</a></li><li><a href="global.html#setBoxState">setBoxState</a></li><li><a href="global.html#setCancelCallbackThecallbackiscalledwhentheregisterbuttonispressed.">setCancelCallback
The callback is called when the register button is pressed.</a></li><li><a href="global.html#setCorrectAnswer">setCorrectAnswer</a></li><li><a href="global.html#setCurrentSketch">setCurrentSketch</a></li><li><a href="global.html#setDrawUpdate">setDrawUpdate</a></li><li><a href="global.html#setEditCallback">setEditCallback</a></li><li><a href="global.html#setLastSaveTime">setLastSaveTime</a></li><li><a href="global.html#setListener">setListener</a></li><li><a href="global.html#setListeners">setListeners</a></li><li><a href="global.html#setOnSuccessLoginThecallbackiscalledwithoneparameter.">setOnSuccessLogin
The callback is called with one parameter.</a></li><li><a href="global.html#setParentSketch">setParentSketch</a></li><li><a href="global.html#setParentSketchId">setParentSketchId</a></li><li><a href="global.html#setPreferredIndex">setPreferredIndex</a></li><li><a href="global.html#setPreviewText">setPreviewText</a></li><li><a href="global.html#setRedoCallback">setRedoCallback</a></li><li><a href="global.html#setRegisterCallbackThecallbackiscalledwhentheregisterbuttonispressed.">setRegisterCallback
The callback is called when the register button is pressed.</a></li><li><a href="global.html#setRemoveFunction">setRemoveFunction</a></li><li><a href="global.html#setSaveCallback">setSaveCallback</a></li><li><a href="global.html#setSketch">setSketch</a></li><li><a href="global.html#setSketchClickedFunction">setSketchClickedFunction</a></li><li><a href="global.html#setSketchManager">setSketchManager</a></li><li><a href="global.html#setSubmissionInformation">setSubmissionInformation</a></li><li><a href="global.html#setSubmitCallback">setSubmitCallback</a></li><li><a href="global.html#setUiLoaded">setUiLoaded</a></li><li><a href="global.html#setUndoCallback">setUndoCallback</a></li><li><a href="global.html#setupAttributes">setupAttributes</a></li><li><a href="global.html#setupCallbacksSetupsupthecallbackfortheregisterbuttonandthelostpasswordbutton.">setupCallbacks
Setups up the callback for the register button and the lost password button.</a></li><li><a href="global.html#setUpdateList">setUpdateList</a></li><li><a href="global.html#setUpdateTime">setUpdateTime</a></li><li><a href="global.html#setUpEditButtons">setUpEditButtons</a></li><li><a href="global.html#setWrapperFunction">setWrapperFunction</a></li><li><a href="global.html#showFormattedDate">showFormattedDate</a></li><li><a href="global.html#SketchSurfaceManager">SketchSurfaceManager</a></li><li><a href="global.html#speakText">speakText</a></li><li><a href="global.html#SubmissionPanel">SubmissionPanel</a></li><li><a href="global.html#TextBox">TextBox</a></li><li><a href="global.html#TimelineMarker">TimelineMarker</a></li><li><a href="global.html#toggleSelection">toggleSelection</a></li><li><a href="global.html#undoAction">undoAction</a></li><li><a href="global.html#updatePath">updatePath</a></li><li><a href="global.html#writeTextData">writeTextData</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta2</a> on Fri Mar 13 2015 04:13:07 GMT-0500 (CDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
