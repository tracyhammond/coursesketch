<html>
<head>
<meta charset="utf-8">
<title>Command Methods test</title>
<!-- test Library -->
<link rel="import" href="/test/testUtilities/testUtilities.html">

<link rel="import"
    href="/test/testUtilities/fakePage/mockedObjects/mockedObjectsInclude.html">

<!-- file being tested. -->
<script
    src="/src/utilities/persistantData/specificManager/lectureDataManager.js"
    data-cover></script>
</head>
<body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>

    <script>
    QUnit.module("lecture creation");
            test("create new database", function(assert) {
                expect(1);
                var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                if(!isUndefined(dataManager))
                    assert.ok(true, "The datamanager was successfully created.");
            });
            asyncTest("create new lecture", function(assert) {
                expect(1);
                var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                var course = CourseSketch.PROTOBUF_UTIL.SrlCourse();
                course.id = generateUUID();
                setTimeout(function() {
                    dataManager.setCourse(course, function() {
                        var lecture = CourseSketch.PROTOBUF_UTIL.Lecture();
                        lecture.id = generateUUID();
                        lecture.courseId = course.id;
                        lecture.name= "I AM TEST"; 
                        dataManager.insertLecture(lecture);
                        assert.ok(true, "The lecture has been created and can be accessed from the course.");
                        QUnit.start();
                    });
                }, 100);  
            });
            asyncTest("get lectures from course part 1", function(assert) {
                expect(2);
                var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                var course = CourseSketch.PROTOBUF_UTIL.SrlCourse();
                course.id = generateUUID();
                setTimeout(function() {
                    dataManager.setCourse(course, function() {
                        var lecture1 = CourseSketch.PROTOBUF_UTIL.Lecture();
                        var lecture2 = CourseSketch.PROTOBUF_UTIL.Lecture();
                        lecture1.id = generateUUID();
                        lecture2.id = generateUUID();
                        lecture1.name = "I am a test!";
                        lecture2.name = "I am also a test!";
                        lecture1.courseId = course.id;
                        lecture2.courseId = course.id;
                        dataManager.insertLecture(lecture1, undefined,function() {
                            dataManager.insertLecture(lecture2, undefined, function() {
                                dataManager.getCourse(course.id, function(newCourse) {
                                    dataManager.getCourseLectures(newCourse.lectureList, function(lectureList) {
                                        assert.ok(true, "Lectures can be fetched from the database.");
                                        assert.equal(lectureList.length,2 , "Two lectures were inserted and two lectures were returned.");
                                        for(var i = 0; i < lectureList.length; ++i) {
                                            console.log("Lecture found!");
                                            console.log(lectureList[i]);
                                        }QUnit.start();
                                    });// getCourselecture loop
                                });// getCourse
                            });// insertlecture lecture2
                        });// insertlecture lecture1
                        
                    });
                }, 100);  
            });
            /* not hooked up to remote database yet
            asyncTest("get lectures from course part 2 testing DB server", function(assert) {
                      expect(1);
                      var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                      var course = CourseSketch.PROTOBUF_UTIL.SrlCourse();
                      course.id = generateUUID();
                      setTimeout(function() {
                           dataManager.setCourse(course, function() {
                                var lecture1 = CourseSketch.PROTOBUF_UTIL.Lecture();
                                lecture1.id = generateUUID();
                                lecture1.name = "I am a test!";
                                lecture1.courseId = course.id;
                                dataManager.insertLecture(lecture1, function(){
                                    dataManager.getLecturelocal(lecture1.id, function(lecture){
                                                assert.ok(true, "Lectures can be fetched from the database.");
                                                //assert.equal(lecture.id,lecture1.id , "Two lectures were inserted and two lectures were returned.");
                                                                 //console.log("Lecture leng "+ lecture.length);
                                                                 //assert.equal(lecture.name,lecture1.name , "The name is the same");
                                                QUnit.start();
                                            });// getCourselecture loop
                                });// insertlecture lecture1
                          });
                    }, 100);  
                });
             */
            asyncTest("test connection send request", function(assert) {
                var fakeID = generateUUID();
                var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                CourseSketch.connection.sendRequest = function(message) {
                    assert.equal(message.requestType, CourseSketch.PROTOBUF_UTIL.getRequestClass().MessageType.DATA_REQUEST, "Message type is valid.");
                    QUnit.start();  
                };
                var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                var interval = setInterval(function() {
                    if (dataManager.isDatabaseReady()) {
                        clearInterval(interval);
                        dataManager.getCourseLecture(fakeID);
                    }
                }, 100);
            });
            
            asyncTest("Testing Delete ", function(assert){
                      expect(1);
                      var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                      var course = CourseSketch.PROTOBUF_UTIL.SrlCourse();
                      course.id = generateUUID();
                      setTimeout(function() {
                        dataManager.setCourse(course, function() {
                                    var lecture1 = CourseSketch.PROTOBUF_UTIL.Lecture();
                                    lecture1.id = generateUUID();
                                    lecture1.name = "I am a test!";
                                    lecture1.courseId = course.id;
                                        dataManager.insertLecture(lecture1, undefined,function() {
                                            dataManager.deleteLecture(lecture1.id, function(){
                                                dataManager.getCourse(course.id, function(newCourse) {
                                                    dataManager.getCourseLectures(newCourse.lectureList, function(lectureList) {
                                                        assert.equal(lectureList.length,0 , "Two lectures were inserted and two lectures were returned.");
                                                        QUnit.start();
                                                    });// get courselectures
                                                });
                                            });// getCourselecture loop
                                        });// getCourse
                                 });// insertlecture lecture1
                            },100);
                  });
                  asyncTest("create new lecture slide", function(assert) {
                expect(1);
                var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                var course = CourseSketch.PROTOBUF_UTIL.SrlCourse();
                course.id = generateUUID();
                setTimeout(function() {
                    dataManager.setCourse(course, function() {
                        var lecture = CourseSketch.PROTOBUF_UTIL.Lecture();
                        lecture.id = generateUUID();
                        lecture.courseId = course.id;
                        lecture.name= "I AM TEST";
                        var slide = CourseSketch.PROTOBUF_UTIL.LectureSlide();
                        slide.lectureId = lecture.id;
                        slide.id = generateUUID();
                        slide.unlocked = true;
                        dataManager.insertLecture(lecture);
                        dataManager.insertSlide(slide);
                        assert.ok(true, "The lecture has been created and can be accessed from the course.");
                        QUnit.start();        
                    });
                }, 100);
            });
            asyncTest("Testing Delete ", function(assert){
                      expect(1);
                      var dataManager = new SchoolDataManager(CourseSketch.connection.userId, CourseSketch.dataListener, CourseSketch.connection, CourseSketch.PROTOBUF_UTIL.getRequestClass(), dcodeIO.ByteBuffer);
                      var course = CourseSketch.PROTOBUF_UTIL.SrlCourse();
                      course.id = generateUUID();
                      setTimeout(function() {
                        dataManager.setCourse(course, function() {
                                    var lecture1 = CourseSketch.PROTOBUF_UTIL.Lecture();
                                    lecture1.id = generateUUID();
                                    lecture1.name = "I am a test!";
                                    lecture1.courseId = course.id;
                                        dataManager.insertLecture(lecture1, undefined,function() {
                                            dataManager.deleteLecture(lecture1.id, function(){
                                                dataManager.getCourse(course.id, function(newCourse) {
                                                    dataManager.getCourseLectures(newCourse.lectureList, function(lectureList) {
                                                        assert.equal(lectureList.length,0 , "Two lectures were inserted and two lectures were returned.");
                                                        QUnit.start();
                                                    });// get courselectures
                                                });
                                            });// getCourselecture loop
                                        });// getCourse
                                 });// insertlecture lecture1
                            },100);
                  });
        </script>
</body>