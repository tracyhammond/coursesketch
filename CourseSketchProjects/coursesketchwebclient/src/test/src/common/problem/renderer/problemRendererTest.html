<html>
<head>
    <meta charset="utf-8">
    <title>Submission Panel Test</title>
    <!-- test Library -->
    <link rel="import" href="/test/testUtilities/testUtilities.html">
    <link rel="import"
          href="/test/testUtilities/fakePage/fakeTestData/fakeTestDataInclude.html">
    <script src="/test/testUtilities/databaseHelper.js"></script>

    <!-- multi-choice -->
    <link rel="import" href="/src/utilities/templates/multiChoice/multiChoiceInclude.html"/>
    <!-- embedded HTML -->
    <link rel="import" href="/src/utilities/templates/embeddedHtml/embeddedHtmlInclude.html"/>
    <!-- sketching -->
    <link rel="import" href="/src/sketching/sketchInclude.html"/>
    <!-- question -->
    <link rel="import" href="/src/utilities/templates/question/questionInclude.html"/>

    <!-- file being tested. -->
    <script src="/src/common/problem/renderer/problemRenderer.js" data-cover></script>
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture"></div>
<div id="htmlCode"></div>
<div id="testBed"></div>

<script>
    QUnit.module("waiting", {
        beforeEach: function() {
            this.fakeElement = document.createElement('div');
            document.getElementById('testBed').appendChild(this.fakeElement);
        },
        afterEach: function() {
            document.getElementById('testBed').innerHTML = '';
        }
    });

    QUnit.test("testing default waiting functions", function(assert) {
        expect(3);
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        renderer.setFinishWaitingFunction(function() {
            assert.ok(true);
        });
        renderer.setStartWaitingFunction(function() {
            assert.ok(true);
        });
        renderer.renderBankProblem(undefined, function() {
            assert.ok(true);
        })
    });

    QUnit.test("testing renderer when it is already waiting.", function(assert) {
        expect(2);
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        renderer.setFinishWaitingFunction(function() {
            assert.ok(false);
        });
        renderer.setStartWaitingFunction(function() {
            assert.ok(true);
        });
        renderer.startWaiting();
        renderer.renderBankProblem(undefined, function() {
            assert.ok(true);
        })
    });

    QUnit.test("testing renderer when it is already waiting force stop waiting.", function(assert) {
        expect(3);
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        renderer.setFinishWaitingFunction(function() {
            assert.ok(true);
        });
        renderer.setStartWaitingFunction(function() {
            assert.ok(true);
        });
        renderer.startWaiting();
        renderer.renderBankProblem(undefined, function() {
            assert.ok(true);
        }, true);
    });

    QUnit.test("testing renderer when it is already waiting prevent stop waiting.", function(assert) {
        expect(2);
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        renderer.setFinishWaitingFunction(function() {
            assert.ok(false);
        });
        renderer.setStartWaitingFunction(function() {
            assert.ok(true);
        });
        renderer.renderBankProblem(undefined, function() {
            assert.ok(true);
        }, false);
    });

    QUnit.test("testing empty special data", function(assert) {
        expect(2);
        var fakeElement = this.fakeElement;
        var done = assert.async();
        this.fakeElement.emptyPanel = function() {
            assert.ok(true);
        };
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        // Free response with starting text
        var bankProblem = CourseSketch.fakeBankProblems[0];
        renderer.renderBankProblem(bankProblem, function() {
            assert.equal(fakeElement.childNodes.length, 0);
            done();
        });
    });

    QUnit.test("testing free response bank problem.", function(assert) {
        expect(3);
        var fakeElement = this.fakeElement;
        var done = assert.async();
        this.fakeElement.emptyPanel = function() {
            assert.ok(true);
        };
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        // Free response with starting text
        var bankProblem = CourseSketch.fakeBankProblems[1];
        renderer.renderBankProblem(bankProblem, function() {
            var element = fakeElement.querySelector('TextArea');
            assert.notEqual(element, null);
            assert.equal(element.value, bankProblem.specialQuestionData.freeResponse.startingText);
            done();
        });
    });

    QUnit.test("testing empty free response bank problem.", function(assert) {
        expect(3);
        var fakeElement = this.fakeElement;
        var done = assert.async();
        this.fakeElement.emptyPanel = function() {
            assert.ok(true);
        };
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        // Free response with starting text
        var bankProblem = CourseSketch.prutil.SrlBankProblem();
        bankProblem.questionType = CourseSketch.prutil.QuestionType.FREE_RESP;
        bankProblem.specialQuestionData = CourseSketch.prutil.QuestionData();
        renderer.renderBankProblem(bankProblem, function() {
            var element = fakeElement.querySelector('TextArea');
            assert.notEqual(element, null);
            assert.equal(element.value, '');
            done();
        });
    });

    QUnit.test("testing multi choice bank problem.", function(assert) {
        expect(3);
        var fakeElement = this.fakeElement;
        var done = assert.async();
        this.fakeElement.emptyPanel = function() {
            assert.ok(true);
        };
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        // Free response with starting text
        var bankProblem = CourseSketch.fakeBankProblems[2];
        renderer.renderBankProblem(bankProblem, function() {
            var element = fakeElement.querySelector('multi-choice');
            assert.notEqual(element, null);
            element.setFinishedListener(function(ignore, ignore, ignore, multiChoice) {
                assert.protoEqual(multiChoice, bankProblem.specialQuestionData.multipleChoice,
                    CourseSketch.prutil.getMultipleChoiceClass(), 'Multi choice should be the same');
                done();
            });
            element.saveData();
        });
    });

    QUnit.test("testing multi choice empty bank problem.", function(assert) {
        expect(3);
        var fakeElement = this.fakeElement;
        var done = assert.async();
        this.fakeElement.emptyPanel = function() {
            assert.ok(true);
        };
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        // Free response with starting text
        var bankProblem = CourseSketch.prutil.SrlBankProblem();
        bankProblem.questionType = CourseSketch.prutil.QuestionType.MULT_CHOICE;
        bankProblem.specialQuestionData = CourseSketch.prutil.QuestionData();
        renderer.renderBankProblem(bankProblem, function() {
            var element = fakeElement.querySelector('multi-choice');
            assert.notEqual(element, null);
            element.setFinishedListener(function(ignore, ignore, ignore, multiChoice) {
                assert.protoEqual(multiChoice, CourseSketch.prutil.MultipleChoice(),
                    CourseSketch.prutil.getMultipleChoiceClass(), 'Multi choice should be the same');
                done();
            });
            element.saveData();
        });
    });

    QUnit.test("testing sketch surface bank problem.", function(assert) {
        expect(3);
        var fakeElement = this.fakeElement;
        var done = assert.async();
        this.fakeElement.emptyPanel = function() {
            assert.ok(true);
        };
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        // Free response with starting text
        var bankProblem = CourseSketch.fakeBankProblems[4];
        renderer.renderBankProblem(bankProblem, function() {
            var element = fakeElement.querySelector('sketch-surface');
            assert.notEqual(element, null);
            var updateList = element.getUpdateList();
            assert.gt(updateList.length, 10);
            done();
        });
    });

    QUnit.test("testing sketch empty bank problem.", function(assert) {
        expect(2);
        var fakeElement = this.fakeElement;
        var done = assert.async();
        this.fakeElement.emptyPanel = function() {
            assert.ok(true);
        };
        var renderer = new CourseSketch.ProblemRenderer(this.fakeElement);
        // Free response with starting text
        var bankProblem = CourseSketch.prutil.SrlBankProblem();
        bankProblem.questionType = CourseSketch.prutil.QuestionType.SKETCH;
        bankProblem.specialQuestionData = CourseSketch.prutil.QuestionData();
        renderer.renderBankProblem(bankProblem, function() {
            var element = fakeElement.querySelector('sketch-surface');
            assert.notEqual(element, null);
            done();
        });
    });
</script>
</body>
