<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recognition Example</title>
    <link rel="import"
          href="/src/utilities/libraries/materialize/materializeInclude.html">

    <!-- basic utilities -->
    <link rel="import" href="/src/utilities/defaultUtils.html">
    <script type="text/javascript" src="/src/utilities/functions/childScript.js"
            data-namespace="courseManagement"></script>

    <!-- protobuf -->
    <link rel="import" href="/src/utilities/connection/protobufInclude.html">

    <!-- special elements -->
    <link rel="import" href="/src/sketching/sketchInclude.html">
    <script src="/src/common/recognition/recognitionManager.js"></script>

</head>
<body>
<div style="height: 600px;position: relative;">
    <sketch-surface id="hello" style="height: 100%; border: 5px solid red;"></sketch-surface>
    <input id="label" type="text" />
    <button id="submitTemplate">Submit Template</button>
    <button id="enableLiveRecognition">Enable Live Recogntion</button>
    <button id="recognize">Recognize Current Template</button>
</div>
    <script>
        $(document).ready(function() {
            var elements = document.getElementsByTagName('sketch-surface');
            console.log(elements);
            var sketchSurface = elements[0];
            var updateManager = sketchSurface.getUpdateManager();

            var resized = false;
            updateManager.addPlugin({
                addUpdate: function() {
                    if (!resized) {
                        sketchSurface.resizeSurface();
                        sketchSurface.refreshSketch();
                        resized = true;
                    }
                }
            });
            sketchSurface.resizeSurface();
            $('#submitTemplate').click(function() {
                var sketch = sketchSurface.getCurrentSketch();
                var protoBuf = sketch.sendToProtobuf();
                var label = document.getElementById('label').value;
                CourseSketch.recognition.addSketchTemplate(label, '' + sketchSurface.id, protoBuf, function(err, success) {
                   console.log(err, success);
                });
            });
            $('#enableLiveRecognition').click(function() {
                // TODO: disable add template
                updateManager.addPlugin(CourseSketch.createRecognitionPlugin(updateManager, sketchSurface.id));
            });
            $('#recognize').click(function() {
                // TODO: disable add template
                updateManager.getCleanUpdateList(function(updateList) {
                    console.log(updateList);
                    var srlUpdateList = CourseSketch.prutil.SrlUpdateList();
                    srlUpdateList.list = updateList;
                    CourseSketch.recognition.recognize(sketchSurface.id, srlUpdateList, function(err, msg) {
                        console.log(err, msg);
                        var updateList = msg.changes;
                        var updates = updateList.list;
                        for (var i = 0; i < updates.length; i++) {
                            var update = updates[i];
                            console.log('add update', update);
                            updateManager.addUpdate(update);
                        }
                    });
                });
            })
        });
    </script>
</body>
</html>
